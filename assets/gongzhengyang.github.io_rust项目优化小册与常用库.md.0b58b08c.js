import{_ as s,o as a,c as n,Q as p}from"./chunks/framework.ec8f7e8e.js";const h=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[],"relativePath":"gongzhengyang.github.io/rust项目优化小册与常用库.md","filePath":"gongzhengyang.github.io/rust项目优化小册与常用库.md"}'),l={name:"gongzhengyang.github.io/rust项目优化小册与常用库.md"},o=p(`<h2 id="常用命令" tabindex="-1">常用命令 <a class="header-anchor" href="#常用命令" aria-label="Permalink to &quot;常用命令&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># 代码格式优化</span></span>
<span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cargo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">fmt</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 检查语法上的小优化</span></span>
<span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cargo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">clippy</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># 代码格式优化</span></span>
<span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cargo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">fmt</span><span style="color:#24292E;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 检查语法上的小优化</span></span>
<span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cargo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">clippy</span></span></code></pre></div><h2 id="cargo-toml配置优化" tabindex="-1"><code>Cargo.toml</code>配置优化 <a class="header-anchor" href="#cargo-toml配置优化" aria-label="Permalink to &quot;\`Cargo.toml\`配置优化&quot;">​</a></h2><p>配置开启<code>lto</code>优化，减少编译中二进制文件无用代码，删除无用<code>debug</code></p><p>优化符号信息<code>symbols</code></p><div class="language-toml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">toml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#B392F0;">profile</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">release</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">lto = </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">strip = </span><span style="color:#79B8FF;">true</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[</span><span style="color:#6F42C1;">profile</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">release</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">lto = </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">strip = </span><span style="color:#005CC5;">true</span></span></code></pre></div><h2 id="找到cargo-toml中未使用的依赖项" tabindex="-1">找到<code>Cargo.toml</code>中未使用的依赖项 <a class="header-anchor" href="#找到cargo-toml中未使用的依赖项" aria-label="Permalink to &quot;找到\`Cargo.toml\`中未使用的依赖项&quot;">​</a></h2><p>依赖项目</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">https://github.com/est31/cargo-udeps</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">https://github.com/est31/cargo-udeps</span></span></code></pre></div><p>安装</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cargo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cargo-udeps</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--locked</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cargo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cargo-udeps</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--locked</span></span></code></pre></div><p>检测未使用的依赖</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cargo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">+nightly</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">udeps</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cargo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">+nightly</span><span style="color:#24292E;"> </span><span style="color:#032F62;">udeps</span></span></code></pre></div><p>或者</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cargo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">udeps</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cargo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">udeps</span></span></code></pre></div><p>有些依赖如果只出现在<code>rust macros/cfg attr</code>中时，会产生误报，需要注意</p><h2 id="cargo-toml文件fmt" tabindex="-1"><code>Cargo.toml</code>文件<code>fmt</code> <a class="header-anchor" href="#cargo-toml文件fmt" aria-label="Permalink to &quot;\`Cargo.toml\`文件\`fmt\`&quot;">​</a></h2><p>主要是优化<code>toml</code>文件中的格式，无其他影响</p><p>依赖项目</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">https://github.com/segeljakt/toml-fmt</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">https://github.com/segeljakt/toml-fmt</span></span></code></pre></div><p>安装</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cargo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">toml-fmt</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cargo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">toml-fmt</span></span></code></pre></div><p><code>fmt</code>优化<code>Cargo.toml</code></p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cargo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">tomlfmt</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cargo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">tomlfmt</span></span></code></pre></div><h2 id="使用nextest加快单元测试速度" tabindex="-1">使用<code>nextest</code>加快单元测试速度 <a class="header-anchor" href="#使用nextest加快单元测试速度" aria-label="Permalink to &quot;使用\`nextest\`加快单元测试速度&quot;">​</a></h2><p>当项目越来越大的时候，跑一次单元测试耗时比较久，使用<code>nextest</code>可以显著加快单元测试速度</p><p>依赖项目</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">https://github.com/nextest-rs/nextest</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">https://github.com/nextest-rs/nextest</span></span></code></pre></div><p>安装</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cargo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cargo-nextest</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--locked</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cargo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cargo-nextest</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--locked</span></span></code></pre></div><p>进行单元测试</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cargo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nextest</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">run</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cargo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nextest</span><span style="color:#24292E;"> </span><span style="color:#032F62;">run</span></span></code></pre></div><h2 id="std-collections-优化" tabindex="-1"><code>std::collections::*</code>优化 <a class="header-anchor" href="#std-collections-优化" aria-label="Permalink to &quot;\`std::collections::*\`优化&quot;">​</a></h2><p>第三方库<code>parking_lot</code>提供了一些类<code>Mutex</code>, <code>RwLock</code>, <code>Condvar</code> , <code>Once</code></p><p>更小，更快，更灵活</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">https://github.com/Amanieu/parking_lot</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">https://github.com/Amanieu/parking_lot</span></span></code></pre></div><p>项目作者描述<code>发现parking lot::Mutex在无数据竞争时比std::sync::Mutex快1.5倍，在多线程时比std::sync::Mutex快5倍，其他类的测试速度更明显</code></p><p>原文</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">When tested on x86_64 Linux, parking_lot::Mutex was found to be 1.5x faster than std::sync::Mutex when uncontended, and up to 5x faster when contended from multiple threads. The numbers for RwLock vary depending on the number of reader and writer threads, but are almost always faster than the standard library RwLock, and even up to 50x faster in some cases.</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">When tested on x86_64 Linux, parking_lot::Mutex was found to be 1.5x faster than std::sync::Mutex when uncontended, and up to 5x faster when contended from multiple threads. The numbers for RwLock vary depending on the number of reader and writer threads, but are almost always faster than the standard library RwLock, and even up to 50x faster in some cases.</span></span></code></pre></div><p>使用</p><p>修改<code>Cargo.toml</code></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">[dependencies]</span></span>
<span class="line"><span style="color:#e1e4e8;">parking_lot = &quot;0.12&quot; # 注意后期版本变更</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">[dependencies]</span></span>
<span class="line"><span style="color:#24292e;">parking_lot = &quot;0.12&quot; # 注意后期版本变更</span></span></code></pre></div><div class="language-rust vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">parking_lot</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">Mutex</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">fn</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">let</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">mut</span><span style="color:#E1E4E8;"> m </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Mutex</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">new</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">m</span><span style="color:#F97583;">.</span><span style="color:#B392F0;">get_mut</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">11</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">assert_eq!</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">m</span><span style="color:#F97583;">.</span><span style="color:#B392F0;">lock</span><span style="color:#E1E4E8;">(), </span><span style="color:#79B8FF;">11</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">parking_lot</span><span style="color:#D73A49;">::</span><span style="color:#6F42C1;">Mutex</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">fn</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">let</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">mut</span><span style="color:#24292E;"> m </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Mutex</span><span style="color:#D73A49;">::</span><span style="color:#6F42C1;">new</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">10</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">m</span><span style="color:#D73A49;">.</span><span style="color:#6F42C1;">get_mut</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">11</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">assert_eq!</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">m</span><span style="color:#D73A49;">.</span><span style="color:#6F42C1;">lock</span><span style="color:#24292E;">(), </span><span style="color:#005CC5;">11</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h2 id="std-collections-hashmap-hashset-优化" tabindex="-1"><code>std::collections::{HashMap, HashSet}</code>优化 <a class="header-anchor" href="#std-collections-hashmap-hashset-优化" aria-label="Permalink to &quot;\`std::collections::{HashMap, HashSet}\`优化&quot;">​</a></h2><p>依赖项目</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">https://github.com/xacrimon/dashmap</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">https://github.com/xacrimon/dashmap</span></span></code></pre></div><p><code>rust</code>中速度超快的并发<code>HashMap</code>，针对高并发读，写优化，同时也提供了<code>DashSet</code>用于替换<code>std::collections::HashSet</code>，基准测试比较查看地址</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">https://github.com/xacrimon/conc-map-bench</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">https://github.com/xacrimon/conc-map-bench</span></span></code></pre></div><p>使用</p><p><code>Cargo.toml</code></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">dashmap = &quot;5.5&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">dashmap = &quot;5.5&quot;</span></span></code></pre></div><p><code>main.rs</code></p><div class="language-rust vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">dashmap</span><span style="color:#F97583;">::</span><span style="color:#E1E4E8;">{</span><span style="color:#B392F0;">DashMap</span><span style="color:#E1E4E8;">, </span><span style="color:#B392F0;">DashSet</span><span style="color:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">fn</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">let</span><span style="color:#E1E4E8;"> dm </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">DashMap</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">new</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    dm</span><span style="color:#F97583;">.</span><span style="color:#B392F0;">insert</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">assert_eq!</span><span style="color:#E1E4E8;">(dm</span><span style="color:#F97583;">.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">&amp;</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">.</span><span style="color:#B392F0;">unwrap</span><span style="color:#E1E4E8;">()</span><span style="color:#F97583;">.</span><span style="color:#B392F0;">value</span><span style="color:#E1E4E8;">(), </span><span style="color:#F97583;">&amp;</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">let</span><span style="color:#E1E4E8;"> set </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">DashSet</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">new</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    set</span><span style="color:#F97583;">.</span><span style="color:#B392F0;">insert</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">assert_eq!</span><span style="color:#E1E4E8;">(set</span><span style="color:#F97583;">.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">&amp;</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">.</span><span style="color:#B392F0;">as_deref</span><span style="color:#E1E4E8;">(), </span><span style="color:#B392F0;">Some</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">&amp;</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">dashmap</span><span style="color:#D73A49;">::</span><span style="color:#24292E;">{</span><span style="color:#6F42C1;">DashMap</span><span style="color:#24292E;">, </span><span style="color:#6F42C1;">DashSet</span><span style="color:#24292E;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">fn</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">let</span><span style="color:#24292E;"> dm </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">DashMap</span><span style="color:#D73A49;">::</span><span style="color:#6F42C1;">new</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    dm</span><span style="color:#D73A49;">.</span><span style="color:#6F42C1;">insert</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">assert_eq!</span><span style="color:#24292E;">(dm</span><span style="color:#D73A49;">.</span><span style="color:#6F42C1;">get</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">&amp;</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">.</span><span style="color:#6F42C1;">unwrap</span><span style="color:#24292E;">()</span><span style="color:#D73A49;">.</span><span style="color:#6F42C1;">value</span><span style="color:#24292E;">(), </span><span style="color:#D73A49;">&amp;</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">let</span><span style="color:#24292E;"> set </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">DashSet</span><span style="color:#D73A49;">::</span><span style="color:#6F42C1;">new</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    set</span><span style="color:#D73A49;">.</span><span style="color:#6F42C1;">insert</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">assert_eq!</span><span style="color:#24292E;">(set</span><span style="color:#D73A49;">.</span><span style="color:#6F42C1;">get</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">&amp;</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">.</span><span style="color:#6F42C1;">as_deref</span><span style="color:#24292E;">(), </span><span style="color:#6F42C1;">Some</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">&amp;</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">));</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h2 id="benchmark" tabindex="-1"><code>benchmark</code> <a class="header-anchor" href="#benchmark" aria-label="Permalink to &quot;\`benchmark\`&quot;">​</a></h2><p>写了一段代码，发现速度好像不够快，或者感觉好像换一个数据类型可以更快，最靠谱实在的就是使用基准测试了</p><p>基准测试针对代码，可以用来测试某一段代码的运行速度，例如一个排序算法</p><p>依赖项目</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">https://github.com/bheisler/criterion.rs</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">https://github.com/bheisler/criterion.rs</span></span></code></pre></div><p>图表生成</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">http://www.gnuplot.info/</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">http://www.gnuplot.info/</span></span></code></pre></div><p>为了生成可视化基准测试图表，需要安装<code>gnuplot</code>工具，如果是在<code>Ubuntu</code>系统上，可以直接通过命令安装<code>sudo apt install gnuplot</code>，基准测试结束之后可以使用浏览器打开<code>target/criterion/report/index.html</code>文件查看图表可以看到更详细直观的性能测试报告</p><p>以下代码<code>copy from criterion</code>的文档</p><p>修改<code>Cargo.toml</code></p><p><code>harness = false</code>表示禁用 <code>libtest</code> 基准测试工具，这样就需要提供自己的<code>main</code>函数来处理基准测试，<code>**benchmark.rs</code>中会使用<code>criterion::criterion_main!</code>作为<code>main</code>函数<code>benchmark harness</code></p><div class="language-toml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">toml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#B392F0;">dev-dependencies</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">criterion = { version = </span><span style="color:#9ECBFF;">&quot;0.5&quot;</span><span style="color:#E1E4E8;">, features = [</span><span style="color:#9ECBFF;">&quot;html_reports&quot;</span><span style="color:#E1E4E8;">] }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[[</span><span style="color:#B392F0;">bench</span><span style="color:#E1E4E8;">]]</span></span>
<span class="line"><span style="color:#E1E4E8;">name = </span><span style="color:#9ECBFF;">&quot;my_benchmark&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">harness = </span><span style="color:#79B8FF;">false</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[</span><span style="color:#6F42C1;">dev-dependencies</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">criterion = { version = </span><span style="color:#032F62;">&quot;0.5&quot;</span><span style="color:#24292E;">, features = [</span><span style="color:#032F62;">&quot;html_reports&quot;</span><span style="color:#24292E;">] }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[[</span><span style="color:#6F42C1;">bench</span><span style="color:#24292E;">]]</span></span>
<span class="line"><span style="color:#24292E;">name = </span><span style="color:#032F62;">&quot;my_benchmark&quot;</span></span>
<span class="line"><span style="color:#24292E;">harness = </span><span style="color:#005CC5;">false</span></span></code></pre></div><p>新建测试文件<code>$PROJECT/benches/my_benchmark.rs</code></p><p>由于测试时候使用的是一个固定的值，<code>LLVM</code>认为<code>fibonacci</code>函数调用的结果没有使用，同时也认为该函数没有任何副作用(造成其它的影响，例如修改外部变量、访问网络等)，因此有理由把这个函数调用优化掉，导致基准测试异常，所以需要使用一个<code>black_box</code>函数包裹参数防止编译器优化这个参数输入或者函数</p><div class="language-rust vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">criterion</span><span style="color:#F97583;">::</span><span style="color:#E1E4E8;">{black_box, criterion_group, criterion_main, </span><span style="color:#B392F0;">Criterion</span><span style="color:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">fn</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">fibonacci</span><span style="color:#E1E4E8;">(n</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">u64</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">-&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">u64</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">match</span><span style="color:#E1E4E8;"> n {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        n </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">fibonacci</span><span style="color:#E1E4E8;">(n</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">fibonacci</span><span style="color:#E1E4E8;">(n</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">fn</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">criterion_benchmark</span><span style="color:#E1E4E8;">(c</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;mut</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Criterion</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    c</span><span style="color:#F97583;">.</span><span style="color:#B392F0;">bench_function</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;fib 20&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">b</span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> b</span><span style="color:#F97583;">.</span><span style="color:#B392F0;">iter</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">fibonacci</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">black_box</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;">))));</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">criterion_group!</span><span style="color:#E1E4E8;">(benches, criterion_benchmark);</span></span>
<span class="line"><span style="color:#B392F0;">criterion_main!</span><span style="color:#E1E4E8;">(benches);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">criterion</span><span style="color:#D73A49;">::</span><span style="color:#24292E;">{black_box, criterion_group, criterion_main, </span><span style="color:#6F42C1;">Criterion</span><span style="color:#24292E;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">fn</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">fibonacci</span><span style="color:#24292E;">(n</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">u64</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">u64</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">match</span><span style="color:#24292E;"> n {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        n </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">fibonacci</span><span style="color:#24292E;">(n</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">fibonacci</span><span style="color:#24292E;">(n</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">),</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">fn</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">criterion_benchmark</span><span style="color:#24292E;">(c</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;mut</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Criterion</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">    c</span><span style="color:#D73A49;">.</span><span style="color:#6F42C1;">bench_function</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;fib 20&quot;</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">b</span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> b</span><span style="color:#D73A49;">.</span><span style="color:#6F42C1;">iter</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">fibonacci</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">black_box</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">20</span><span style="color:#24292E;">))));</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">criterion_group!</span><span style="color:#24292E;">(benches, criterion_benchmark);</span></span>
<span class="line"><span style="color:#6F42C1;">criterion_main!</span><span style="color:#24292E;">(benches);</span></span></code></pre></div><p>执行命令如下</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cargo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">bench</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 如下输出也是copy官方文档的，下面逐行说明输出数据</span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#B392F0;">Running</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">target/release/deps/example-423eedc43b2b3a93</span></span>
<span class="line"><span style="color:#B392F0;">Benchmarking</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">fib</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">20</span></span>
<span class="line"><span style="color:#6A737D;"># 预热，默认3秒，为了预热处理器缓存和文件系统缓存，模拟真实生产环境</span></span>
<span class="line"><span style="color:#B392F0;">Benchmarking</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">fib</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">20</span><span style="color:#9ECBFF;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Warming</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">up</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">for</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3.0000</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">s</span></span>
<span class="line"><span style="color:#6A737D;"># 收集样本数据，使用不同次数的迭代来迭代要进行基准测试的函数，以生成每次迭代所花费时间的估计</span></span>
<span class="line"><span style="color:#B392F0;">Benchmarking</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">alloc:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Collecting</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">samples</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">estimated</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">13.354</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;"> (5050 </span><span style="color:#9ECBFF;">iterations</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#B392F0;">Benchmarking</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">alloc:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Analyzing</span></span>
<span class="line"><span style="color:#6A737D;"># time 显示了该基准测试测量的每次迭代时间的置信区间</span></span>
<span class="line"><span style="color:#6A737D;"># 左值和右值分别表示置信区间的下界和上界，中间值表示对基准测试每次迭代所花费时间的最佳估计</span></span>
<span class="line"><span style="color:#B392F0;">alloc</span><span style="color:#E1E4E8;">                   </span><span style="color:#9ECBFF;">time:</span><span style="color:#E1E4E8;">   [2.5094 </span><span style="color:#9ECBFF;">ms</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2.5306</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ms</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2.5553</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ms]</span></span>
<span class="line"><span style="color:#6A737D;"># 基准代码的吞吐量</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#B392F0;">thrpt:</span><span style="color:#E1E4E8;">  [391.34 </span><span style="color:#9ECBFF;">MiB/s</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">395.17</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">MiB/s</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">398.51</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">MiB/s]</span></span>
<span class="line"><span style="color:#6A737D;"># 当运行基准测试时，criterion 统计信息保存在 target/criterion 目录</span></span>
<span class="line"><span style="color:#6A737D;"># 基准测试的后续执行将加载此数据并将其与当前示例进行比较，以显示代码更改的影响</span></span>
<span class="line"><span style="color:#6A737D;"># p 表示本次基准运行与上一次基准运行之间差异的置信区间测量到的差异可能偶然发生的概率</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#B392F0;">change:</span><span style="color:#E1E4E8;"> [-38.292% </span><span style="color:#79B8FF;">-37.342%</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-36.524%</span><span style="color:#E1E4E8;">] (</span><span style="color:#B392F0;">p</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0.00</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0.05</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#6A737D;"># 针对change的数据进行简单摘要说明，(Performance has regressed[性能下降]，Performance has improved.[性能上升])</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#B392F0;">Performance</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">has</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">improved.</span></span>
<span class="line"><span style="color:#6A737D;"># 异常高或低的样本报告为异常值，大量异常值表明基准测试结果存在噪音</span></span>
<span class="line"><span style="color:#6A737D;"># 这可能是由于运行基准测试的计算机上不可预测的负载、线程或进程调度、或者被基准测试的代码所用时间的不规则性造成的，可能有其他高负载程序干扰</span></span>
<span class="line"><span style="color:#B392F0;">Found</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">outliers</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">among</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">measurements</span><span style="color:#E1E4E8;"> (8.00%)</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">4</span><span style="color:#E1E4E8;"> (4.00%) high mild</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">4</span><span style="color:#E1E4E8;"> (4.00%) high severe</span></span>
<span class="line"><span style="color:#6A737D;"># slope显示线性回归斜率的置信区间，R^2 区域显示该置信区间下限和上限的拟合优度值</span></span>
<span class="line"><span style="color:#6A737D;"># 如果 R^2 值较低，这可能表明基准测试在每次迭代中没有执行相同的工作量。</span></span>
<span class="line"><span style="color:#B392F0;">slope</span><span style="color:#E1E4E8;">  [2.5094 </span><span style="color:#9ECBFF;">ms</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2.5553</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ms]</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">R^2</span><span style="color:#E1E4E8;">            [0.8660614 </span><span style="color:#79B8FF;">0.8640630</span><span style="color:#9ECBFF;">]</span></span>
<span class="line"><span style="color:#6A737D;"># 显示每次迭代时间的平均值和标准差的置信区间</span></span>
<span class="line"><span style="color:#B392F0;">mean</span><span style="color:#E1E4E8;">   [2.5142 </span><span style="color:#9ECBFF;">ms</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2.5557</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ms]</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">std.</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">dev.</span><span style="color:#E1E4E8;">      [62.868 </span><span style="color:#9ECBFF;">us</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">149.50</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">us]</span></span>
<span class="line"><span style="color:#6A737D;"># 中位数和中位数绝对偏差绝对值的置信区间</span></span>
<span class="line"><span style="color:#B392F0;">median</span><span style="color:#E1E4E8;"> [2.5023 </span><span style="color:#9ECBFF;">ms</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2.5262</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ms]</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">med.</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">abs.</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">dev.</span><span style="color:#E1E4E8;"> [40.034 </span><span style="color:#9ECBFF;">us</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">73.259</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">us]</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cargo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">bench</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 如下输出也是copy官方文档的，下面逐行说明输出数据</span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#6F42C1;">Running</span><span style="color:#24292E;"> </span><span style="color:#032F62;">target/release/deps/example-423eedc43b2b3a93</span></span>
<span class="line"><span style="color:#6F42C1;">Benchmarking</span><span style="color:#24292E;"> </span><span style="color:#032F62;">fib</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">20</span></span>
<span class="line"><span style="color:#6A737D;"># 预热，默认3秒，为了预热处理器缓存和文件系统缓存，模拟真实生产环境</span></span>
<span class="line"><span style="color:#6F42C1;">Benchmarking</span><span style="color:#24292E;"> </span><span style="color:#032F62;">fib</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">20</span><span style="color:#032F62;">:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Warming</span><span style="color:#24292E;"> </span><span style="color:#032F62;">up</span><span style="color:#24292E;"> </span><span style="color:#032F62;">for</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3.0000</span><span style="color:#24292E;"> </span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6A737D;"># 收集样本数据，使用不同次数的迭代来迭代要进行基准测试的函数，以生成每次迭代所花费时间的估计</span></span>
<span class="line"><span style="color:#6F42C1;">Benchmarking</span><span style="color:#24292E;"> </span><span style="color:#032F62;">alloc:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Collecting</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">100</span><span style="color:#24292E;"> </span><span style="color:#032F62;">samples</span><span style="color:#24292E;"> </span><span style="color:#032F62;">in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">estimated</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">13.354</span><span style="color:#24292E;"> </span><span style="color:#032F62;">s</span><span style="color:#24292E;"> (5050 </span><span style="color:#032F62;">iterations</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#6F42C1;">Benchmarking</span><span style="color:#24292E;"> </span><span style="color:#032F62;">alloc:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Analyzing</span></span>
<span class="line"><span style="color:#6A737D;"># time 显示了该基准测试测量的每次迭代时间的置信区间</span></span>
<span class="line"><span style="color:#6A737D;"># 左值和右值分别表示置信区间的下界和上界，中间值表示对基准测试每次迭代所花费时间的最佳估计</span></span>
<span class="line"><span style="color:#6F42C1;">alloc</span><span style="color:#24292E;">                   </span><span style="color:#032F62;">time:</span><span style="color:#24292E;">   [2.5094 </span><span style="color:#032F62;">ms</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2.5306</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ms</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2.5553</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ms]</span></span>
<span class="line"><span style="color:#6A737D;"># 基准代码的吞吐量</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#6F42C1;">thrpt:</span><span style="color:#24292E;">  [391.34 </span><span style="color:#032F62;">MiB/s</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">395.17</span><span style="color:#24292E;"> </span><span style="color:#032F62;">MiB/s</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">398.51</span><span style="color:#24292E;"> </span><span style="color:#032F62;">MiB/s]</span></span>
<span class="line"><span style="color:#6A737D;"># 当运行基准测试时，criterion 统计信息保存在 target/criterion 目录</span></span>
<span class="line"><span style="color:#6A737D;"># 基准测试的后续执行将加载此数据并将其与当前示例进行比较，以显示代码更改的影响</span></span>
<span class="line"><span style="color:#6A737D;"># p 表示本次基准运行与上一次基准运行之间差异的置信区间测量到的差异可能偶然发生的概率</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#6F42C1;">change:</span><span style="color:#24292E;"> [-38.292% </span><span style="color:#005CC5;">-37.342%</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-36.524%</span><span style="color:#24292E;">] (</span><span style="color:#6F42C1;">p</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0.00</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0.05</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#6A737D;"># 针对change的数据进行简单摘要说明，(Performance has regressed[性能下降]，Performance has improved.[性能上升])</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#6F42C1;">Performance</span><span style="color:#24292E;"> </span><span style="color:#032F62;">has</span><span style="color:#24292E;"> </span><span style="color:#032F62;">improved.</span></span>
<span class="line"><span style="color:#6A737D;"># 异常高或低的样本报告为异常值，大量异常值表明基准测试结果存在噪音</span></span>
<span class="line"><span style="color:#6A737D;"># 这可能是由于运行基准测试的计算机上不可预测的负载、线程或进程调度、或者被基准测试的代码所用时间的不规则性造成的，可能有其他高负载程序干扰</span></span>
<span class="line"><span style="color:#6F42C1;">Found</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">8</span><span style="color:#24292E;"> </span><span style="color:#032F62;">outliers</span><span style="color:#24292E;"> </span><span style="color:#032F62;">among</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">100</span><span style="color:#24292E;"> </span><span style="color:#032F62;">measurements</span><span style="color:#24292E;"> (8.00%)</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">4</span><span style="color:#24292E;"> (4.00%) high mild</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">4</span><span style="color:#24292E;"> (4.00%) high severe</span></span>
<span class="line"><span style="color:#6A737D;"># slope显示线性回归斜率的置信区间，R^2 区域显示该置信区间下限和上限的拟合优度值</span></span>
<span class="line"><span style="color:#6A737D;"># 如果 R^2 值较低，这可能表明基准测试在每次迭代中没有执行相同的工作量。</span></span>
<span class="line"><span style="color:#6F42C1;">slope</span><span style="color:#24292E;">  [2.5094 </span><span style="color:#032F62;">ms</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2.5553</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ms]</span><span style="color:#24292E;"> </span><span style="color:#032F62;">R^2</span><span style="color:#24292E;">            [0.8660614 </span><span style="color:#005CC5;">0.8640630</span><span style="color:#032F62;">]</span></span>
<span class="line"><span style="color:#6A737D;"># 显示每次迭代时间的平均值和标准差的置信区间</span></span>
<span class="line"><span style="color:#6F42C1;">mean</span><span style="color:#24292E;">   [2.5142 </span><span style="color:#032F62;">ms</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2.5557</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ms]</span><span style="color:#24292E;"> </span><span style="color:#032F62;">std.</span><span style="color:#24292E;"> </span><span style="color:#032F62;">dev.</span><span style="color:#24292E;">      [62.868 </span><span style="color:#032F62;">us</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">149.50</span><span style="color:#24292E;"> </span><span style="color:#032F62;">us]</span></span>
<span class="line"><span style="color:#6A737D;"># 中位数和中位数绝对偏差绝对值的置信区间</span></span>
<span class="line"><span style="color:#6F42C1;">median</span><span style="color:#24292E;"> [2.5023 </span><span style="color:#032F62;">ms</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2.5262</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ms]</span><span style="color:#24292E;"> </span><span style="color:#032F62;">med.</span><span style="color:#24292E;"> </span><span style="color:#032F62;">abs.</span><span style="color:#24292E;"> </span><span style="color:#032F62;">dev.</span><span style="color:#24292E;"> [40.034 </span><span style="color:#032F62;">us</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">73.259</span><span style="color:#24292E;"> </span><span style="color:#032F62;">us]</span></span></code></pre></div><p>命令行输出数据参考阅读</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">https://bheisler.github.io/criterion.rs/book/user_guide/command_line_output.html</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">https://bheisler.github.io/criterion.rs/book/user_guide/command_line_output.html</span></span></code></pre></div><p>详细阅读参考</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">https://bheisler.github.io/criterion.rs/book/getting_started.html</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">https://bheisler.github.io/criterion.rs/book/getting_started.html</span></span></code></pre></div><h2 id="异步递归调用" tabindex="-1">异步递归调用 <a class="header-anchor" href="#异步递归调用" aria-label="Permalink to &quot;异步递归调用&quot;">​</a></h2><div class="language-rust vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">async</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">fn</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">fib</span><span style="color:#E1E4E8;">(n </span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">u32</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">-&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">u32</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">match</span><span style="color:#E1E4E8;"> n {</span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">       _ </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">fib</span><span style="color:#E1E4E8;">(n</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">.await</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">fib</span><span style="color:#E1E4E8;">(n</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">.await</span></span>
<span class="line"><span style="color:#E1E4E8;">   }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">async</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">fn</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">fib</span><span style="color:#24292E;">(n </span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">u32</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">u32</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">match</span><span style="color:#24292E;"> n {</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">       _ </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">fib</span><span style="color:#24292E;">(n</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">.await</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">fib</span><span style="color:#24292E;">(n</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">.await</span></span>
<span class="line"><span style="color:#24292E;">   }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>当出现一段递归代码如上，由于<code>fib</code>函数是异步的，所以编译的时候会报错如下</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">error[E0733]: recursion in an \`async fn\` requires boxing</span></span>
<span class="line"><span style="color:#e1e4e8;"> --&gt; src/main.rs:1:26</span></span>
<span class="line"><span style="color:#e1e4e8;">  |</span></span>
<span class="line"><span style="color:#e1e4e8;">1 | async fn fib(n : u32) -&gt; u32 {</span></span>
<span class="line"><span style="color:#e1e4e8;">  |                          ^^^ recursive \`async fn\`</span></span>
<span class="line"><span style="color:#e1e4e8;">  |</span></span>
<span class="line"><span style="color:#e1e4e8;">  = note: a recursive \`async fn\` must be rewritten to return a boxed \`dyn Future\`</span></span>
<span class="line"><span style="color:#e1e4e8;">  = note: consider using the \`async_recursion\` crate: https://crates.io/crates/async_recursion</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">error[E0733]: recursion in an \`async fn\` requires boxing</span></span>
<span class="line"><span style="color:#24292e;"> --&gt; src/main.rs:1:26</span></span>
<span class="line"><span style="color:#24292e;">  |</span></span>
<span class="line"><span style="color:#24292e;">1 | async fn fib(n : u32) -&gt; u32 {</span></span>
<span class="line"><span style="color:#24292e;">  |                          ^^^ recursive \`async fn\`</span></span>
<span class="line"><span style="color:#24292e;">  |</span></span>
<span class="line"><span style="color:#24292e;">  = note: a recursive \`async fn\` must be rewritten to return a boxed \`dyn Future\`</span></span>
<span class="line"><span style="color:#24292e;">  = note: consider using the \`async_recursion\` crate: https://crates.io/crates/async_recursion</span></span></code></pre></div><p>可以使用依赖库</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">https://github.com/dcchut/async-recursion</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">https://github.com/dcchut/async-recursion</span></span></code></pre></div><p><code>Cargo.toml</code></p><div class="language-toml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">toml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#B392F0;">dependencies</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">tokio = {version = </span><span style="color:#9ECBFF;">&quot;1&quot;</span><span style="color:#E1E4E8;">, features = [</span><span style="color:#9ECBFF;">&quot;full&quot;</span><span style="color:#E1E4E8;">]}</span></span>
<span class="line"><span style="color:#E1E4E8;">async-recursion = </span><span style="color:#9ECBFF;">&quot;1&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[</span><span style="color:#6F42C1;">dependencies</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">tokio = {version = </span><span style="color:#032F62;">&quot;1&quot;</span><span style="color:#24292E;">, features = [</span><span style="color:#032F62;">&quot;full&quot;</span><span style="color:#24292E;">]}</span></span>
<span class="line"><span style="color:#24292E;">async-recursion = </span><span style="color:#032F62;">&quot;1&quot;</span></span></code></pre></div><p><code>main.rs</code></p><div class="language-rust vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">async_recursion</span><span style="color:#F97583;">::</span><span style="color:#E1E4E8;">async_recursion;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">#[tokio</span><span style="color:#F97583;">::</span><span style="color:#E1E4E8;">main]</span></span>
<span class="line"><span style="color:#F97583;">async</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">fn</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">println!</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;{}&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#B392F0;">fib</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">.await</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">#[async_recursion]</span></span>
<span class="line"><span style="color:#F97583;">async</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">fn</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">fib</span><span style="color:#E1E4E8;">(n </span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">u32</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">-&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">u32</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">match</span><span style="color:#E1E4E8;"> n {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        _ </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">fib</span><span style="color:#E1E4E8;">(n</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">.await</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">fib</span><span style="color:#E1E4E8;">(n</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">.await</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">async_recursion</span><span style="color:#D73A49;">::</span><span style="color:#24292E;">async_recursion;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">#[tokio</span><span style="color:#D73A49;">::</span><span style="color:#24292E;">main]</span></span>
<span class="line"><span style="color:#D73A49;">async</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">fn</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">println!</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;{}&quot;</span><span style="color:#24292E;">, </span><span style="color:#6F42C1;">fib</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">.await</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">#[async_recursion]</span></span>
<span class="line"><span style="color:#D73A49;">async</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">fn</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">fib</span><span style="color:#24292E;">(n </span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">u32</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">u32</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">match</span><span style="color:#24292E;"> n {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        _ </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">fib</span><span style="color:#24292E;">(n</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">.await</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">fib</span><span style="color:#24292E;">(n</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">.await</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h2 id="高性能线程安全的多读少写库" tabindex="-1">高性能线程安全的多读少写库 <a class="header-anchor" href="#高性能线程安全的多读少写库" aria-label="Permalink to &quot;高性能线程安全的多读少写库&quot;">​</a></h2><p>需求：</p><ul><li>能够从多个线程快速、频繁且并发地读取数据结构的当前值</li><li>在较长时间内使用相同版本的数据结构 - 查询应由一致版本的数据来回答，数据包应通过旧版本或新版本的路由表进行路由，而不是通过组合进行路由</li><li>执行更新而不中断处理</li></ul><p>在有些场景下面，我们会使用一个静态变量，可以被多个线程读取，同时会有少量情况会进行数据修改</p><p>实现方式</p><ul><li><p>采用<code> RwLock&lt;T&gt;/ RwLock&lt;Arc&lt;T&gt;&gt;</code>这样的数据结构来实现，通过读写锁来保证安全，但是该数据类型会有一个问题，当进行写操作时，所有的读程序都会被阻塞，同时在不同的场景下，写操作可能会被稳定持续不断的读操作一直阻塞较长时间</p></li><li><p>采用<code>ArcSwap</code>实现，该库对读操作进行了优化，数据结构类似于<code>Atomic&lt;Arc&lt;T&gt;&gt;</code>，没有了锁，具有稳定的性能，仓库地址</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">https://github.com/vorner/arc-swap</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">https://github.com/vorner/arc-swap</span></span></code></pre></div></li></ul><p>使用</p><p><code>Cargo.toml</code></p><div class="language-toml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">toml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#B392F0;">dependencies</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">tokio = {version = </span><span style="color:#9ECBFF;">&quot;1&quot;</span><span style="color:#E1E4E8;">, features = [</span><span style="color:#9ECBFF;">&quot;full&quot;</span><span style="color:#E1E4E8;">]}</span></span>
<span class="line"><span style="color:#E1E4E8;">arc-swap = </span><span style="color:#9ECBFF;">&quot;1.6&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">once_cell = </span><span style="color:#9ECBFF;">&quot;1&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[</span><span style="color:#6F42C1;">dependencies</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">tokio = {version = </span><span style="color:#032F62;">&quot;1&quot;</span><span style="color:#24292E;">, features = [</span><span style="color:#032F62;">&quot;full&quot;</span><span style="color:#24292E;">]}</span></span>
<span class="line"><span style="color:#24292E;">arc-swap = </span><span style="color:#032F62;">&quot;1.6&quot;</span></span>
<span class="line"><span style="color:#24292E;">once_cell = </span><span style="color:#032F62;">&quot;1&quot;</span></span></code></pre></div><p><code>main.rs</code></p><div class="language-rust vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">std</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">sync</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">Arc</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">std</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">time</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">Duration</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">arc_swap</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">ArcSwap</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">once_cell</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">sync</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">Lazy</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">VALUE</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Lazy</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#B392F0;">ArcSwap</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#B392F0;">String</span><span style="color:#E1E4E8;">&gt;&gt; </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Lazy</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">new</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ArcSwap</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">from</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">Arc</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">new</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;test&quot;</span><span style="color:#F97583;">.</span><span style="color:#B392F0;">to_owned</span><span style="color:#E1E4E8;">())));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">#[tokio</span><span style="color:#F97583;">::</span><span style="color:#E1E4E8;">main]</span></span>
<span class="line"><span style="color:#F97583;">async</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">fn</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">tokio</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">spawn</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">async</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">tokio</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">time</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">sleep</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">Duration</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">from_secs</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">))</span><span style="color:#F97583;">.await</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">VALUE</span><span style="color:#F97583;">.</span><span style="color:#B392F0;">swap</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">Arc</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">new</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;changed&quot;</span><span style="color:#F97583;">.</span><span style="color:#B392F0;">to_owned</span><span style="color:#E1E4E8;">()));</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">loop</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">println!</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;now value is {}&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">VALUE</span><span style="color:#F97583;">.</span><span style="color:#B392F0;">load</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">tokio</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">time</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">sleep</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">Duration</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">from_secs</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">))</span><span style="color:#F97583;">.await</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">std</span><span style="color:#D73A49;">::</span><span style="color:#6F42C1;">sync</span><span style="color:#D73A49;">::</span><span style="color:#6F42C1;">Arc</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">std</span><span style="color:#D73A49;">::</span><span style="color:#6F42C1;">time</span><span style="color:#D73A49;">::</span><span style="color:#6F42C1;">Duration</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">arc_swap</span><span style="color:#D73A49;">::</span><span style="color:#6F42C1;">ArcSwap</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">once_cell</span><span style="color:#D73A49;">::</span><span style="color:#6F42C1;">sync</span><span style="color:#D73A49;">::</span><span style="color:#6F42C1;">Lazy</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">VALUE</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Lazy</span><span style="color:#24292E;">&lt;</span><span style="color:#6F42C1;">ArcSwap</span><span style="color:#24292E;">&lt;</span><span style="color:#6F42C1;">String</span><span style="color:#24292E;">&gt;&gt; </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Lazy</span><span style="color:#D73A49;">::</span><span style="color:#6F42C1;">new</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ArcSwap</span><span style="color:#D73A49;">::</span><span style="color:#6F42C1;">from</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">Arc</span><span style="color:#D73A49;">::</span><span style="color:#6F42C1;">new</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;test&quot;</span><span style="color:#D73A49;">.</span><span style="color:#6F42C1;">to_owned</span><span style="color:#24292E;">())));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">#[tokio</span><span style="color:#D73A49;">::</span><span style="color:#24292E;">main]</span></span>
<span class="line"><span style="color:#D73A49;">async</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">fn</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">tokio</span><span style="color:#D73A49;">::</span><span style="color:#6F42C1;">spawn</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">async</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">tokio</span><span style="color:#D73A49;">::</span><span style="color:#6F42C1;">time</span><span style="color:#D73A49;">::</span><span style="color:#6F42C1;">sleep</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">Duration</span><span style="color:#D73A49;">::</span><span style="color:#6F42C1;">from_secs</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">))</span><span style="color:#D73A49;">.await</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">VALUE</span><span style="color:#D73A49;">.</span><span style="color:#6F42C1;">swap</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">Arc</span><span style="color:#D73A49;">::</span><span style="color:#6F42C1;">new</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;changed&quot;</span><span style="color:#D73A49;">.</span><span style="color:#6F42C1;">to_owned</span><span style="color:#24292E;">()));</span></span>
<span class="line"><span style="color:#24292E;">    });</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">loop</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">println!</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;now value is {}&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">VALUE</span><span style="color:#D73A49;">.</span><span style="color:#6F42C1;">load</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">tokio</span><span style="color:#D73A49;">::</span><span style="color:#6F42C1;">time</span><span style="color:#D73A49;">::</span><span style="color:#6F42C1;">sleep</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">Duration</span><span style="color:#D73A49;">::</span><span style="color:#6F42C1;">from_secs</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">))</span><span style="color:#D73A49;">.await</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>以上代码输出是</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">now value is test</span></span>
<span class="line"><span style="color:#e1e4e8;">now value is test</span></span>
<span class="line"><span style="color:#e1e4e8;">now value is changed</span></span>
<span class="line"><span style="color:#e1e4e8;">now value is changed</span></span>
<span class="line"><span style="color:#e1e4e8;">now value is changed</span></span>
<span class="line"><span style="color:#e1e4e8;">....</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">now value is test</span></span>
<span class="line"><span style="color:#24292e;">now value is test</span></span>
<span class="line"><span style="color:#24292e;">now value is changed</span></span>
<span class="line"><span style="color:#24292e;">now value is changed</span></span>
<span class="line"><span style="color:#24292e;">now value is changed</span></span>
<span class="line"><span style="color:#24292e;">....</span></span></code></pre></div><h2 id="参考阅读" tabindex="-1">参考阅读 <a class="header-anchor" href="#参考阅读" aria-label="Permalink to &quot;参考阅读&quot;">​</a></h2><p><a href="https://bheisler.github.io/criterion.rs/book/getting_started.html" target="_blank" rel="noreferrer"><code>Criterion.rs Documentation Getting Started</code></a></p>`,99),e=[o];function c(t,r,y,E,i,F){return a(),n("div",null,e)}const u=s(l,[["render",c]]);export{h as __pageData,u as default};
