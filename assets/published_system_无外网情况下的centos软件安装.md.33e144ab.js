import{_ as s,o as a,c as l,Q as o}from"./chunks/framework.36bc40e2.js";const F=JSON.parse('{"title":"背景","description":"","frontmatter":{},"headers":[],"relativePath":"published/system/无外网情况下的centos软件安装.md","filePath":"published/system/无外网情况下的centos软件安装.md","lastUpdated":1700106669000}'),n={name:"published/system/无外网情况下的centos软件安装.md"},p=o(`<h1 id="背景" tabindex="-1">背景 <a class="header-anchor" href="#背景" aria-label="Permalink to &quot;背景&quot;">​</a></h1><p>有些时候在一些内网环境部署机器的时候，要用一个跳板机，再通过跳板机<code>ssh</code>到目标机器，最后发现目标机器是不能访问外网的，目标机器居然还不能反向<code>ping</code>跳板机或者<code>ssh</code>到跳板机，通过<code>iptables -nvL</code>和<code>ip route</code>以及<code>arp -n</code>综合分析之后，决定老实点通过<code>scp</code>上传<code>rpm</code>方式解决</p><h2 id="前提" tabindex="-1">前提 <a class="header-anchor" href="#前提" aria-label="Permalink to &quot;前提&quot;">​</a></h2><p>首先需要参看目标机器的系统信息，发现目标机器是<code>centos 7</code>版本</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">$ cat /etc/os-release</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">$ cat /etc/os-release</span></span></code></pre></div><p>准备一个全新的对应目标机器系统版本的机器，这一点非常重要</p><p>我试过从跳板机以及从<code>centos docker</code>镜像容器获取对应软件的安装包，最后复制到目标机器的时候执行，发现经常缺失各种依赖</p><p>最靠谱的还是去找个<code>centos7-minimal</code>版本的镜像，装在虚拟机上面，进行如下操作</p><h2 id="本地机器具体操作" tabindex="-1">本地机器具体操作 <a class="header-anchor" href="#本地机器具体操作" aria-label="Permalink to &quot;本地机器具体操作&quot;">​</a></h2><p>获取一个系统镜像，下载地址，选择<code>minimal</code>版本，这样确保获取软件<code>rpm</code>包的时候获取更多的依赖数据</p><p>页面地址如下</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">http://mirrors.ustc.edu.cn/centos/7.9.2009/isos/x86_64/</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">http://mirrors.ustc.edu.cn/centos/7.9.2009/isos/x86_64/</span></span></code></pre></div><p>下载地址</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">http://iso.mirrors.ustc.edu.cn/centos/7.9.2009/isos/x86_64/CentOS-7-x86_64-Minimal-2009.iso</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">http://iso.mirrors.ustc.edu.cn/centos/7.9.2009/isos/x86_64/CentOS-7-x86_64-Minimal-2009.iso</span></span></code></pre></div><p>系统安装完成之后执行如下命令，更换默认软件源</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">sudo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">sed</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-e</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;s|^mirrorlist=|#mirrorlist=|g&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">-e</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;s|^#baseurl=http://mirror.centos.org/centos|baseurl=https://mirrors.ustc.edu.cn/centos|g&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">-i.bak</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#9ECBFF;">/etc/yum.repos.d/CentOS-Base.repo</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">sudo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">sed</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-e</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;s|^mirrorlist=|#mirrorlist=|g&#39;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#005CC5;">-e</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;s|^#baseurl=http://mirror.centos.org/centos|baseurl=https://mirrors.ustc.edu.cn/centos|g&#39;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#005CC5;">-i.bak</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#032F62;">/etc/yum.repos.d/CentOS-Base.repo</span></span></code></pre></div><p>清除旧缓存，创建新缓存</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">yum</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">clean</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">all</span></span>
<span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">yum</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">makecache</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">yum</span><span style="color:#24292E;"> </span><span style="color:#032F62;">clean</span><span style="color:#24292E;"> </span><span style="color:#032F62;">all</span></span>
<span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">yum</span><span style="color:#24292E;"> </span><span style="color:#032F62;">makecache</span></span></code></pre></div><p>安装依赖包</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">yum</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">yum-utils</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-y</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">yum</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">yum-utils</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-y</span></span></code></pre></div><p>只获取包而不安装软件，<code>--downloadonly</code>表示只下载，<code>--downloaddir</code>指定软件包的位置，最后是软件名称，</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">yum</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--downloadonly</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--downloaddir=/tmp/soft</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">package-nam</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">yum</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--downloadonly</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--downloaddir=/tmp/soft</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">package-nam</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span></code></pre></div><p>最后把整个文件夹用<code>scp</code>上传到跳板机，目标机器</p><h2 id="目标机器操作" tabindex="-1">目标机器操作 <a class="header-anchor" href="#目标机器操作" aria-label="Permalink to &quot;目标机器操作&quot;">​</a></h2><p><code>cd</code>到包含有<code>rpm</code>包的文件夹位置执行如下命令，禁用软件源避免<code>yum</code>请求网络的时候报错</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">yum</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">localinstall</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">*</span><span style="color:#9ECBFF;">.rpm</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--disablerepo=</span><span style="color:#F97583;">*</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">yum</span><span style="color:#24292E;"> </span><span style="color:#032F62;">localinstall</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">*</span><span style="color:#032F62;">.rpm</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--disablerepo=</span><span style="color:#D73A49;">*</span></span></code></pre></div><p>如果遇到依赖版本不匹配冲突错误，比如已经安装有某个版本的软件，修改安装命令如下</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rpm</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-ivh</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--force</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--nodeps</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">*</span><span style="color:#9ECBFF;">.rpm</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rpm</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-ivh</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--force</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--nodeps</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">*</span><span style="color:#032F62;">.rpm</span></span></code></pre></div><p>如果遇上依赖缺失错误，比如类似下面的输出</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">错误：软件包：python-dmidecode-3.12.2-4.el7.x86_64 (/python-dmidecode-3.12.2-4.el7.x86_64)</span></span>
<span class="line"><span style="color:#e1e4e8;">          需要：libxml2mod.so()(64bit)</span></span>
<span class="line"><span style="color:#e1e4e8;">错误：软件包：1:containers-common-0.1.40-11.el7_8.x86_64 (/containers-common-0.1.40-11.el7_8.x86_64)</span></span>
<span class="line"><span style="color:#e1e4e8;">          需要：fuse-overlayfs</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">错误：软件包：python-dmidecode-3.12.2-4.el7.x86_64 (/python-dmidecode-3.12.2-4.el7.x86_64)</span></span>
<span class="line"><span style="color:#24292e;">          需要：libxml2mod.so()(64bit)</span></span>
<span class="line"><span style="color:#24292e;">错误：软件包：1:containers-common-0.1.40-11.el7_8.x86_64 (/containers-common-0.1.40-11.el7_8.x86_64)</span></span>
<span class="line"><span style="color:#24292e;">          需要：fuse-overlayfs</span></span></code></pre></div><p>则需要重新回到本地<code>centos</code>新机器那边执行，具体软件包名称一般复制粘贴下来就行，有些特殊的找不到的自行搜索，如此循环反复，最终才能安装好</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">yum</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--downloadonly</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--downloaddir=/tmp/soft</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">libxml2mod.so</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">fuse-overlayfs</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">yum</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--downloadonly</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--downloaddir=/tmp/soft</span><span style="color:#24292E;"> </span><span style="color:#032F62;">libxml2mod.so</span><span style="color:#24292E;"> </span><span style="color:#032F62;">fuse-overlayfs</span></span></code></pre></div><h2 id="参考阅读" tabindex="-1">参考阅读 <a class="header-anchor" href="#参考阅读" aria-label="Permalink to &quot;参考阅读&quot;">​</a></h2><p><a href="https://mirrors.ustc.edu.cn/help/centos.html" target="_blank" rel="noreferrer">中科大镜像源</a></p>`,34),e=[p];function c(t,r,i,d,y,E){return a(),l("div",null,e)}const u=s(n,[["render",c]]);export{F as __pageData,u as default};
