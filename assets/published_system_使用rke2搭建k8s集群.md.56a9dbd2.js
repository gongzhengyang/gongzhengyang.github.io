import{_ as s,o as n,c as a,Q as l}from"./chunks/framework.ec8f7e8e.js";const C=JSON.parse('{"title":"背景","description":"","frontmatter":{},"headers":[],"relativePath":"published/system/使用rke2搭建k8s集群.md","filePath":"published/system/使用rke2搭建k8s集群.md"}'),o={name:"published/system/使用rke2搭建k8s集群.md"},p=l(`<h1 id="背景" tabindex="-1">背景 <a class="header-anchor" href="#背景" aria-label="Permalink to &quot;背景&quot;">​</a></h1><p><code>k8s</code>官方部署安装集群的是使用<code>kubeadm</code>方式，但是该方式比较复杂繁琐，所以产生了一些新的部署安装集群方式，比如<code>k3s</code>和<code>rke2</code>等新方式</p><p><code>k3s</code>有着非常庞大的社区支持，部署安装也非常简单，设计为轻量级的<code>k8s</code>，可以很好的运行在物联网设备或者边缘计算设备上面</p><p>据<code>rke2</code>官方文档描述说该部署是继承了<code>k3s</code>的可用性、易操作性和部署模式，继承了与上游 <code>Kubernetes</code> 的紧密一致性，在一些地方，<code>K3s</code> 与上游的 <code>Kubernetes</code> 有分歧(<code>k3s</code>魔改了一些<code>k8s</code>组件)，以便为边缘部署进行优化，<code>rke2</code>同时也预设了安全配置，符合各项安全测试规范，但是部署方式上比<code>k3s</code>更复杂一些</p><p>整体来看选择<code>k3s</code>和<code>rke2</code>都是可以用于生产环境的选择，如果更注重安全性，可以选择<code>rke2</code></p><h2 id="硬件资源" tabindex="-1">硬件资源 <a class="header-anchor" href="#硬件资源" aria-label="Permalink to &quot;硬件资源&quot;">​</a></h2><p>一个高可用集群</p><ul><li>一个注册地址</li><li>一个奇数的<code>server</code>管理节点（推荐最小3个）来运行<code>etcd</code>，<code>kubenetes API</code>以及其他控制面服务</li><li>（可选）零个或多个<code>agent</code> 节点，将运行你的应用程序和服务</li></ul><p>采用<code>Ubuntu</code>服务器，系统版本<code>22.04</code>，二核4<code>G</code></p><p><code>IP</code>地址如下</p><ul><li><code>192.168.100.136</code>（第一个管理节点）</li><li><code>192.168.100.141</code>(管理节点)</li><li><code>192.168.100.142</code>(管理节点)</li><li><code>192.168.100.137</code>(<code>agent</code>节点，可选)</li><li><code>192.168.100.138</code>(<code>agent</code>节点，可选)</li></ul><p>机器之间可以相互<code>ping</code>通</p><p>执行命令过程当中需要<code>sudo</code>权限或者切换为<code>root</code>用户</p><h2 id="第一台管理节点配置" tabindex="-1">第一台管理节点配置 <a class="header-anchor" href="#第一台管理节点配置" aria-label="Permalink to &quot;第一台管理节点配置&quot;">​</a></h2><p>节点<code>IP</code>是<code>192.168.100.136</code></p><p>获取<code>rke2</code>安装程序</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">curl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-sfL</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">https://rancher-mirror.rancher.cn/rke2/install.sh</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> INSTALL_RKE2_MIRROR</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">cn</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">sh</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">-</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">curl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-sfL</span><span style="color:#24292E;"> </span><span style="color:#032F62;">https://rancher-mirror.rancher.cn/rke2/install.sh</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> INSTALL_RKE2_MIRROR</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">cn</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">sh</span><span style="color:#24292E;"> </span><span style="color:#032F62;">-</span></span></code></pre></div><p>创建自定义配置文件</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">mkdir</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/rancher/rke2</span></span>
<span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">vim</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/rancher/rke2/config.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">mkdir</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/rancher/rke2</span></span>
<span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">vim</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/rancher/rke2/config.yaml</span></span></code></pre></div><p>写入内容如下</p><ul><li><code>token</code>参数表示自定义一个<code>token</code>标识</li><li><code>node-name</code>表示配置节点名，该名称是全局唯一的，用于<code>dns</code>路由</li><li><code>tls-san</code>表示<code>TLS</code>证书上添加额外的主机名或<code>IPv4/IPv6</code>地址作为备用名称，此处填写本机<code>IP</code>，该参数是为了避免固定注册地址的证书错误</li><li><code>system-default-registry</code>表示使用国内镜像</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">token</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demo-server</span></span>
<span class="line"><span style="color:#85E89D;">node-name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demo-server-node</span></span>
<span class="line"><span style="color:#85E89D;">tls-san</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">192.168.100.136</span></span>
<span class="line"><span style="color:#85E89D;">system-default-registry</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;registry.cn-hangzhou.aliyuncs.com&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">token</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demo-server</span></span>
<span class="line"><span style="color:#22863A;">node-name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demo-server-node</span></span>
<span class="line"><span style="color:#22863A;">tls-san</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">192.168.100.136</span></span>
<span class="line"><span style="color:#22863A;">system-default-registry</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;registry.cn-hangzhou.aliyuncs.com&quot;</span></span></code></pre></div><p>启动服务（<code>rke2-server</code>是采用<code>systemd</code>管理，确保节点重启后或进程崩溃或被杀时自动重启）</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">start</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rke2-server</span></span>
<span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">enable</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rke2-server</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">start</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rke2-server</span></span>
<span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">enable</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rke2-server</span></span></code></pre></div><p>服务启动后会在<code>/etc/rancher/rke2/rke2.yaml</code>位置生成一个文件包含了集群的信息</p><p>查看安装的二进制执行文件，<code>rke2</code>默认是安装到<code>/var/lib/rancher/rke2/bin/</code>路径下面，但是该路径是不被<code>$PATH</code>所包含的</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ll</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/var/lib/rancher/rke2/bin/</span></span>
<span class="line"><span style="color:#B392F0;">total</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">300396</span></span>
<span class="line"><span style="color:#B392F0;">drwxr-xr-x</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">4096</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Oct</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">08</span><span style="color:#9ECBFF;">:41</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">./</span></span>
<span class="line"><span style="color:#B392F0;">drwxr-xr-x</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">4096</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Oct</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">08</span><span style="color:#9ECBFF;">:41</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">../</span></span>
<span class="line"><span style="color:#B392F0;">-rwxr-xr-x</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">57352072</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Oct</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">08</span><span style="color:#9ECBFF;">:41</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">containerd</span><span style="color:#79B8FF;">*</span></span>
<span class="line"><span style="color:#B392F0;">-rwxr-xr-x</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">7381616</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Oct</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">08</span><span style="color:#9ECBFF;">:41</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">containerd-shim</span><span style="color:#79B8FF;">*</span></span>
<span class="line"><span style="color:#B392F0;">-rwxr-xr-x</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">11606088</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Oct</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">08</span><span style="color:#9ECBFF;">:41</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">containerd-shim-runc-v1</span><span style="color:#79B8FF;">*</span></span>
<span class="line"><span style="color:#B392F0;">-rwxr-xr-x</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">11626984</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Oct</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">08</span><span style="color:#9ECBFF;">:41</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">containerd-shim-runc-v2</span><span style="color:#79B8FF;">*</span></span>
<span class="line"><span style="color:#B392F0;">-rwxr-xr-x</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">24838144</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Oct</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">08</span><span style="color:#9ECBFF;">:41</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">crictl</span><span style="color:#79B8FF;">*</span></span>
<span class="line"><span style="color:#B392F0;">-rwxr-xr-x</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">20586248</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Oct</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">08</span><span style="color:#9ECBFF;">:41</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ctr</span><span style="color:#79B8FF;">*</span></span>
<span class="line"><span style="color:#B392F0;">-rwxr-xr-x</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">48570656</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Oct</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">08</span><span style="color:#9ECBFF;">:41</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl</span><span style="color:#79B8FF;">*</span></span>
<span class="line"><span style="color:#B392F0;">-rwxr-xr-x</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">114644328</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Oct</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">08</span><span style="color:#9ECBFF;">:41</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubelet</span><span style="color:#79B8FF;">*</span></span>
<span class="line"><span style="color:#B392F0;">-rwxr-xr-x</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">10973592</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Oct</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">08</span><span style="color:#9ECBFF;">:41</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">runc</span><span style="color:#79B8FF;">*</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ll</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/var/lib/rancher/rke2/bin/</span></span>
<span class="line"><span style="color:#6F42C1;">total</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">300396</span></span>
<span class="line"><span style="color:#6F42C1;">drwxr-xr-x</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">4096</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Oct</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">8</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">08</span><span style="color:#032F62;">:41</span><span style="color:#24292E;"> </span><span style="color:#032F62;">./</span></span>
<span class="line"><span style="color:#6F42C1;">drwxr-xr-x</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">4096</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Oct</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">8</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">08</span><span style="color:#032F62;">:41</span><span style="color:#24292E;"> </span><span style="color:#032F62;">../</span></span>
<span class="line"><span style="color:#6F42C1;">-rwxr-xr-x</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">57352072</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Oct</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">8</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">08</span><span style="color:#032F62;">:41</span><span style="color:#24292E;"> </span><span style="color:#032F62;">containerd</span><span style="color:#005CC5;">*</span></span>
<span class="line"><span style="color:#6F42C1;">-rwxr-xr-x</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">7381616</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Oct</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">8</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">08</span><span style="color:#032F62;">:41</span><span style="color:#24292E;"> </span><span style="color:#032F62;">containerd-shim</span><span style="color:#005CC5;">*</span></span>
<span class="line"><span style="color:#6F42C1;">-rwxr-xr-x</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">11606088</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Oct</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">8</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">08</span><span style="color:#032F62;">:41</span><span style="color:#24292E;"> </span><span style="color:#032F62;">containerd-shim-runc-v1</span><span style="color:#005CC5;">*</span></span>
<span class="line"><span style="color:#6F42C1;">-rwxr-xr-x</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">11626984</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Oct</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">8</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">08</span><span style="color:#032F62;">:41</span><span style="color:#24292E;"> </span><span style="color:#032F62;">containerd-shim-runc-v2</span><span style="color:#005CC5;">*</span></span>
<span class="line"><span style="color:#6F42C1;">-rwxr-xr-x</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">24838144</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Oct</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">8</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">08</span><span style="color:#032F62;">:41</span><span style="color:#24292E;"> </span><span style="color:#032F62;">crictl</span><span style="color:#005CC5;">*</span></span>
<span class="line"><span style="color:#6F42C1;">-rwxr-xr-x</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">20586248</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Oct</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">8</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">08</span><span style="color:#032F62;">:41</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ctr</span><span style="color:#005CC5;">*</span></span>
<span class="line"><span style="color:#6F42C1;">-rwxr-xr-x</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">48570656</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Oct</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">8</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">08</span><span style="color:#032F62;">:41</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl</span><span style="color:#005CC5;">*</span></span>
<span class="line"><span style="color:#6F42C1;">-rwxr-xr-x</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">114644328</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Oct</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">8</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">08</span><span style="color:#032F62;">:41</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubelet</span><span style="color:#005CC5;">*</span></span>
<span class="line"><span style="color:#6F42C1;">-rwxr-xr-x</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">10973592</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Oct</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">8</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">08</span><span style="color:#032F62;">:41</span><span style="color:#24292E;"> </span><span style="color:#032F62;">runc</span><span style="color:#005CC5;">*</span></span></code></pre></div><p>修改全局<code>PATH</code></p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">vim</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/profile.d/rke2.sh</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 写入如下内容</span></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#E1E4E8;"> PATH</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">$PATH</span><span style="color:#9ECBFF;">:/var/lib/rancher/rke2/bin</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">vim</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/profile.d/rke2.sh</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 写入如下内容</span></span>
<span class="line"><span style="color:#D73A49;">export</span><span style="color:#24292E;"> PATH</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">$PATH</span><span style="color:#032F62;">:/var/lib/rancher/rke2/bin</span></span></code></pre></div><p>重新加载环境</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">source</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/profile</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">source</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/profile</span></span></code></pre></div><p>现在可以执行<code>kubectl</code>命令了，但是发现报错如下</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nodes</span></span>
<span class="line"><span style="color:#B392F0;">The</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">connection</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">server</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">localhost:8080</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">was</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">refused</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">did</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">you</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">specify</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">right</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">host</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">or</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">port?</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nodes</span></span>
<span class="line"><span style="color:#6F42C1;">The</span><span style="color:#24292E;"> </span><span style="color:#032F62;">connection</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">server</span><span style="color:#24292E;"> </span><span style="color:#032F62;">localhost:8080</span><span style="color:#24292E;"> </span><span style="color:#032F62;">was</span><span style="color:#24292E;"> </span><span style="color:#032F62;">refused</span><span style="color:#24292E;"> </span><span style="color:#032F62;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">did</span><span style="color:#24292E;"> </span><span style="color:#032F62;">you</span><span style="color:#24292E;"> </span><span style="color:#032F62;">specify</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">right</span><span style="color:#24292E;"> </span><span style="color:#032F62;">host</span><span style="color:#24292E;"> </span><span style="color:#032F62;">or</span><span style="color:#24292E;"> </span><span style="color:#032F62;">port?</span></span></code></pre></div><p>这个主要是<code>rke2</code>使用的配置文件路径问题</p><p>可以通过临时指定环境变量</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">KUBECONFIG=/etc/rancher/rke2/rke2.yaml</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nodes</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">KUBECONFIG=/etc/rancher/rke2/rke2.yaml</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nodes</span></span></code></pre></div><p>也可以修改<code>/etc/profile.d/rke2.sh</code>新增加一行</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">export KUBECONFIG=/etc/rancher/rke2/rke2.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">export KUBECONFIG=/etc/rancher/rke2/rke2.yaml</span></span></code></pre></div><p>如果执行报错</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">error: error loading config file &quot;/etc/rancher/rke2/rke2.yaml&quot;: open /etc/rancher/rke2/rke2.yaml: permission denied</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">error: error loading config file &quot;/etc/rancher/rke2/rke2.yaml&quot;: open /etc/rancher/rke2/rke2.yaml: permission denied</span></span></code></pre></div><p>需要执行</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">sudo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">chown</span><span style="color:#E1E4E8;"> $USER</span><span style="color:#9ECBFF;">:</span><span style="color:#E1E4E8;">$USER </span><span style="color:#9ECBFF;">/etc/rancher/rke2/rke2.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">sudo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">chown</span><span style="color:#24292E;"> $USER</span><span style="color:#032F62;">:</span><span style="color:#24292E;">$USER </span><span style="color:#032F62;">/etc/rancher/rke2/rke2.yaml</span></span></code></pre></div><p>该节点的<code>rke2 server</code>进程会开放<code>9345</code>端口监听新节点的注册(正常情况下，<code>Kubernetes API</code> 的服务端口是<code>6443</code>，这个开放端口是不同的)，其他节点加入该集群的时候需要在<code>/etc/rancher/rke2/config.yaml</code>配置文件当中加入一行数据</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">server: https://192.168.100.136:9345</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">server: https://192.168.100.136:9345</span></span></code></pre></div><p>验证查看有一个单节点<code>k8s</code></p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nodes</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">               </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">ROLES</span><span style="color:#E1E4E8;">                       </span><span style="color:#9ECBFF;">AGE</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">VERSION</span></span>
<span class="line"><span style="color:#B392F0;">demo-server-node</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">Ready</span><span style="color:#E1E4E8;">      </span><span style="color:#9ECBFF;">control-plane,etcd,master</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">6</span><span style="color:#9ECBFF;">m27s</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">v1.24.6+rke2r1</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nodes</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">               </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">     </span><span style="color:#032F62;">ROLES</span><span style="color:#24292E;">                       </span><span style="color:#032F62;">AGE</span><span style="color:#24292E;">     </span><span style="color:#032F62;">VERSION</span></span>
<span class="line"><span style="color:#6F42C1;">demo-server-node</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Ready</span><span style="color:#24292E;">      </span><span style="color:#032F62;">control-plane,etcd,master</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">6</span><span style="color:#032F62;">m27s</span><span style="color:#24292E;">   </span><span style="color:#032F62;">v1.24.6+rke2r1</span></span></code></pre></div><h2 id="其他server管理节点配置" tabindex="-1">其他<code>server</code>管理节点配置 <a class="header-anchor" href="#其他server管理节点配置" aria-label="Permalink to &quot;其他\`server\`管理节点配置&quot;">​</a></h2><p>配置过程和第一个<code>server</code>管理节点一样，不同的地方在于配置<code>/etc/rancher/rke2/config.yaml</code>文件的时候需要修改一些参数</p><p>写入内容如下</p><ul><li><code>server</code>参数表示第一个管理节点的<code>IP</code>，注意，这个地方使用<code>https</code></li><li><code>token</code>参数保持和第一个管理节点<code>192.168.100.136</code>的<code>/etc/rancher/rke2/config.yaml</code>的<code>token</code>的参数位置一致</li><li><code>node-name</code>配置节点名称，<strong>两个<code>server</code>节点需要配置为不一样的名称</strong></li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">server</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">https://192.168.100.136:9345</span></span>
<span class="line"><span style="color:#85E89D;">token</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demo-server</span></span>
<span class="line"><span style="color:#85E89D;">node-name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demo-server-node-2</span></span>
<span class="line"><span style="color:#85E89D;">tls-san</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">192.168.100.136</span></span>
<span class="line"><span style="color:#85E89D;">system-default-registry</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;registry.cn-hangzhou.aliyuncs.com&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">server</span><span style="color:#24292E;">: </span><span style="color:#032F62;">https://192.168.100.136:9345</span></span>
<span class="line"><span style="color:#22863A;">token</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demo-server</span></span>
<span class="line"><span style="color:#22863A;">node-name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demo-server-node-2</span></span>
<span class="line"><span style="color:#22863A;">tls-san</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">192.168.100.136</span></span>
<span class="line"><span style="color:#22863A;">system-default-registry</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;registry.cn-hangzhou.aliyuncs.com&quot;</span></span></code></pre></div><p>配置完成之后在三台<code>server</code>节点上执行如下命令可以查看节点信息，如果输出如下信息表示高可用集群配置完成</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nodes</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                 </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">ROLES</span><span style="color:#E1E4E8;">                       </span><span style="color:#9ECBFF;">AGE</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">VERSION</span></span>
<span class="line"><span style="color:#B392F0;">demo-server-node</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Ready</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">control-plane,etcd,master</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">22</span><span style="color:#9ECBFF;">m</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">v1.24.6+rke2r1</span></span>
<span class="line"><span style="color:#B392F0;">demo-server-node-2</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">Ready</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">control-plane,etcd,master</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">4</span><span style="color:#9ECBFF;">m5s</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">v1.24.6+rke2r1</span></span>
<span class="line"><span style="color:#B392F0;">demo-server-node-3</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">Ready</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">control-plane,etcd,master</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">22</span><span style="color:#9ECBFF;">m</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">v1.24.6+rke2r1</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nodes</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                 </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">ROLES</span><span style="color:#24292E;">                       </span><span style="color:#032F62;">AGE</span><span style="color:#24292E;">    </span><span style="color:#032F62;">VERSION</span></span>
<span class="line"><span style="color:#6F42C1;">demo-server-node</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Ready</span><span style="color:#24292E;">    </span><span style="color:#032F62;">control-plane,etcd,master</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">22</span><span style="color:#032F62;">m</span><span style="color:#24292E;">    </span><span style="color:#032F62;">v1.24.6+rke2r1</span></span>
<span class="line"><span style="color:#6F42C1;">demo-server-node-2</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Ready</span><span style="color:#24292E;">    </span><span style="color:#032F62;">control-plane,etcd,master</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">m5s</span><span style="color:#24292E;">   </span><span style="color:#032F62;">v1.24.6+rke2r1</span></span>
<span class="line"><span style="color:#6F42C1;">demo-server-node-3</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Ready</span><span style="color:#24292E;">    </span><span style="color:#032F62;">control-plane,etcd,master</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">22</span><span style="color:#032F62;">m</span><span style="color:#24292E;">    </span><span style="color:#032F62;">v1.24.6+rke2r1</span></span></code></pre></div><h2 id="agent节点配置" tabindex="-1"><code>Agent</code>节点配置 <a class="header-anchor" href="#agent节点配置" aria-label="Permalink to &quot;\`Agent\`节点配置&quot;">​</a></h2><p>获取安装程序</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">curl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-sfL</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">https://rancher-mirror.oss-cn-beijing.aliyuncs.com/rke2/install.sh</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> INSTALL_RKE2_MIRROR</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">cn</span><span style="color:#E1E4E8;"> INSTALL_RKE2_TYPE</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;agent&quot;</span><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">sh</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">-</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">curl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-sfL</span><span style="color:#24292E;"> </span><span style="color:#032F62;">https://rancher-mirror.oss-cn-beijing.aliyuncs.com/rke2/install.sh</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> INSTALL_RKE2_MIRROR</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">cn</span><span style="color:#24292E;"> INSTALL_RKE2_TYPE</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;agent&quot;</span><span style="color:#24292E;">  </span><span style="color:#6F42C1;">sh</span><span style="color:#24292E;"> </span><span style="color:#032F62;">-</span></span></code></pre></div><p>创建配置文件</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">mkdir</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/rancher/rke2/</span></span>
<span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">vim</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/rancher/rke2/config.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">mkdir</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/rancher/rke2/</span></span>
<span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">vim</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/rancher/rke2/config.yaml</span></span></code></pre></div><p>写入内容如下</p><ul><li><code>server</code>参数表第一个示管理节点的<code>IP</code>，注意，这个地方使用<code>https</code></li><li><code>node-name</code>配置节点名称，<strong>两个<code>agent</code>节点需要配置为不一样的名称</strong></li><li><code>token</code>参数保持和第一个管理节点<code>192.168.100.136</code>的<code>/etc/rancher/rke2/config.yaml</code>的<code>token</code>的参数位置一致</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">server</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">https://192.168.100.136:9345</span></span>
<span class="line"><span style="color:#85E89D;">node-name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demo-agent1</span></span>
<span class="line"><span style="color:#85E89D;">token</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demo-server</span></span>
<span class="line"><span style="color:#85E89D;">system-default-registry</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;registry.cn-hangzhou.aliyuncs.com&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">server</span><span style="color:#24292E;">: </span><span style="color:#032F62;">https://192.168.100.136:9345</span></span>
<span class="line"><span style="color:#22863A;">node-name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demo-agent1</span></span>
<span class="line"><span style="color:#22863A;">token</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demo-server</span></span>
<span class="line"><span style="color:#22863A;">system-default-registry</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;registry.cn-hangzhou.aliyuncs.com&quot;</span></span></code></pre></div><p>启动<code>agent</code>并配置开机启动</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">start</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rke2-agent</span></span>
<span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">enable</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rke2-agent</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">start</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rke2-agent</span></span>
<span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">enable</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rke2-agent</span></span></code></pre></div><p>两台·<code>agent</code>的操作是基本一样的，<strong>唯一区别就是<code>/etc/rancher/rke2/config.yaml</code>文件中的<code>node-name</code>参数需要不同</strong></p><h2 id="验证集群搭建" tabindex="-1">验证集群搭建 <a class="header-anchor" href="#验证集群搭建" aria-label="Permalink to &quot;验证集群搭建&quot;">​</a></h2><p>在管理节点上执行</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nodes</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                 </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">ROLES</span><span style="color:#E1E4E8;">                       </span><span style="color:#9ECBFF;">AGE</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">VERSION</span></span>
<span class="line"><span style="color:#B392F0;">demo-agent1</span><span style="color:#E1E4E8;">          </span><span style="color:#9ECBFF;">Ready</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">                      </span><span style="color:#79B8FF;">109</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">v1.24.6+rke2r1</span></span>
<span class="line"><span style="color:#B392F0;">demo-agent2</span><span style="color:#E1E4E8;">          </span><span style="color:#9ECBFF;">Ready</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">                      </span><span style="color:#79B8FF;">66</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">v1.24.6+rke2r1</span></span>
<span class="line"><span style="color:#B392F0;">demo-server-node</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Ready</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">control-plane,etcd,master</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">36</span><span style="color:#9ECBFF;">m</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">v1.24.6+rke2r1</span></span>
<span class="line"><span style="color:#B392F0;">demo-server-node-2</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">Ready</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">control-plane,etcd,master</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">17</span><span style="color:#9ECBFF;">m</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">v1.24.6+rke2r1</span></span>
<span class="line"><span style="color:#B392F0;">demo-server-node-3</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">Ready</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">control-plane,etcd,master</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">35</span><span style="color:#9ECBFF;">m</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">v1.24.6+rke2r1</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nodes</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                 </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">ROLES</span><span style="color:#24292E;">                       </span><span style="color:#032F62;">AGE</span><span style="color:#24292E;">    </span><span style="color:#032F62;">VERSION</span></span>
<span class="line"><span style="color:#6F42C1;">demo-agent1</span><span style="color:#24292E;">          </span><span style="color:#032F62;">Ready</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">                      </span><span style="color:#005CC5;">109</span><span style="color:#032F62;">s</span><span style="color:#24292E;">   </span><span style="color:#032F62;">v1.24.6+rke2r1</span></span>
<span class="line"><span style="color:#6F42C1;">demo-agent2</span><span style="color:#24292E;">          </span><span style="color:#032F62;">Ready</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">                      </span><span style="color:#005CC5;">66</span><span style="color:#032F62;">s</span><span style="color:#24292E;">    </span><span style="color:#032F62;">v1.24.6+rke2r1</span></span>
<span class="line"><span style="color:#6F42C1;">demo-server-node</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Ready</span><span style="color:#24292E;">    </span><span style="color:#032F62;">control-plane,etcd,master</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">36</span><span style="color:#032F62;">m</span><span style="color:#24292E;">    </span><span style="color:#032F62;">v1.24.6+rke2r1</span></span>
<span class="line"><span style="color:#6F42C1;">demo-server-node-2</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Ready</span><span style="color:#24292E;">    </span><span style="color:#032F62;">control-plane,etcd,master</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">17</span><span style="color:#032F62;">m</span><span style="color:#24292E;">    </span><span style="color:#032F62;">v1.24.6+rke2r1</span></span>
<span class="line"><span style="color:#6F42C1;">demo-server-node-3</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Ready</span><span style="color:#24292E;">    </span><span style="color:#032F62;">control-plane,etcd,master</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">35</span><span style="color:#032F62;">m</span><span style="color:#24292E;">    </span><span style="color:#032F62;">v1.24.6+rke2r1</span></span></code></pre></div><h2 id="非root用户使用" tabindex="-1">非<code>root</code>用户使用 <a class="header-anchor" href="#非root用户使用" aria-label="Permalink to &quot;非\`root\`用户使用&quot;">​</a></h2><p>在非特权用户下面执行<code>kubectl</code>命令时候报错权限不足</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nodes</span></span>
<span class="line"><span style="color:#B392F0;">error:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">error</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">loading</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">config</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">file</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;/etc/rancher/rke2/rke2.yaml&quot;:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">open</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/rancher/rke2/rke2.yaml:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">permission</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">denied</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nodes</span></span>
<span class="line"><span style="color:#6F42C1;">error:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">error</span><span style="color:#24292E;"> </span><span style="color:#032F62;">loading</span><span style="color:#24292E;"> </span><span style="color:#032F62;">config</span><span style="color:#24292E;"> </span><span style="color:#032F62;">file</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;/etc/rancher/rke2/rke2.yaml&quot;:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">open</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/rancher/rke2/rke2.yaml:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">permission</span><span style="color:#24292E;"> </span><span style="color:#032F62;">denied</span></span></code></pre></div><p>修改相关文件权限</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">$ sudo chown $USER:$USER /etc/rancher/rke2/rke2.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">$ sudo chown $USER:$USER /etc/rancher/rke2/rke2.yaml</span></span></code></pre></div><h2 id="配置kubectl补全" tabindex="-1">配置<code>kubectl</code>补全 <a class="header-anchor" href="#配置kubectl补全" aria-label="Permalink to &quot;配置\`kubectl\`补全&quot;">​</a></h2><p>安装</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">sudo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">apt-get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">bash-completion</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">sudo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apt-get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">bash-completion</span></span></code></pre></div><p>配置<code>~/.bashrc</code>新增如下两行，这个地方是命令补全的关键</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#79B8FF;">source</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/usr/share/bash-completion/bash_completion</span></span>
<span class="line"><span style="color:#79B8FF;">source</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&lt;(</span><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> completion bash)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#005CC5;">source</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/usr/share/bash-completion/bash_completion</span></span>
<span class="line"><span style="color:#005CC5;">source</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&lt;(</span><span style="color:#6F42C1;">kubectl</span><span style="color:#032F62;"> completion bash)</span></span></code></pre></div><p>当前<code>shell</code>生效</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">source</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">~/.bashrc</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">source</span><span style="color:#24292E;"> </span><span style="color:#032F62;">~/.bashrc</span></span></code></pre></div><h2 id="配置镜像仓库" tabindex="-1">配置镜像仓库 <a class="header-anchor" href="#配置镜像仓库" aria-label="Permalink to &quot;配置镜像仓库&quot;">​</a></h2><p>配置国内镜像源加快镜像拉取</p><p>配置私有镜像仓库</p><p>编辑文件<code>/etc/rancher/rke2/registries.yaml</code>写入如下信息</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">mirrors</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">docker.io</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">endpoint</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#9ECBFF;">&quot;https://docker.mirrors.ustc.edu.cn&quot;</span></span>
<span class="line"><span style="color:#85E89D;">configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">&quot;harbor.example.com&quot;</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">auth</span><span style="color:#E1E4E8;">: </span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">username</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">user</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">password</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">pass</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">tls</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">insecure_skip_verify</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;"># cert_file: # path to the cert file used to authenticate to the registry</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;"># key_file: # path to the key file for the certificate used to authenticate to the registry</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;"># ca_file: # path to the ca file used to verify the registry&#39;s certificate</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">mirrors</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">docker.io</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">endpoint</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#032F62;">&quot;https://docker.mirrors.ustc.edu.cn&quot;</span></span>
<span class="line"><span style="color:#22863A;">configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#032F62;">&quot;harbor.example.com&quot;</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">auth</span><span style="color:#24292E;">: </span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">username</span><span style="color:#24292E;">: </span><span style="color:#032F62;">user</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">password</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pass</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">tls</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">insecure_skip_verify</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6A737D;"># cert_file: # path to the cert file used to authenticate to the registry</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6A737D;"># key_file: # path to the key file for the certificate used to authenticate to the registry</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6A737D;"># ca_file: # path to the ca file used to verify the registry&#39;s certificate</span></span></code></pre></div><h4 id="mirrors字段说明" tabindex="-1"><code>mirrors</code>字段说明 <a class="header-anchor" href="#mirrors字段说明" aria-label="Permalink to &quot;\`mirrors\`字段说明&quot;">​</a></h4><ul><li>表示当拉取镜像的时候，会把<code>docker.io</code>重定向到国内的镜像网站<code>https://docker.mirrors.ustc.edu.cn</code></li></ul><h4 id="configs字段说明" tabindex="-1"><code>configs</code>字段说明 <a class="header-anchor" href="#configs字段说明" aria-label="Permalink to &quot;\`configs\`字段说明&quot;">​</a></h4><ul><li><p>该段内容表示配置私有镜像仓库，比如自己搭建的<code>harbor</code>仓库，如果没有私人仓库，则<code>configs</code>段配置可以省略</p></li><li><p><code>harbor.example.com</code>填写镜像仓库的地址</p></li><li><p><code>auth</code>块下面的<code>username</code>和<code>password</code>填写仓库的登录账号密码</p></li><li><p>如果镜像仓库访问使用<code>https</code>（使用了<code>tls</code>），则需要填写<code>tls</code>块的信息</p></li><li><p>如果不验证<code>CA</code>证书，则<code>tls</code>下面填写<code>insecure_skip_verify: true</code>即可，如果要验证证书，则需要填写<code>cert_file</code>，<code>key_file</code>，<code>ca_file</code>三个参数</p></li></ul><p>每个节点都需要配置该文件确保获取镜像</p><h2 id="验证集群部署工作负载" tabindex="-1">验证集群部署工作负载 <a class="header-anchor" href="#验证集群部署工作负载" aria-label="Permalink to &quot;验证集群部署工作负载&quot;">​</a></h2><p>在任意一个<code>server</code>节点创建一个文件<code>deployment-nginx.xml</code>写入如下</p><p>把<code>spec.template.spec.containers[].image</code>字段替换为私有镜像地址可以验证私有镜像仓库配置是否正确</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Deployment</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demo-deployment-nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">replicas</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">10</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">matchLabels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demo-nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Deployment</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demo-deployment-nginx</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">replicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">10</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demo-nginx</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span></code></pre></div><p>执行命令</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">apply</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">deployment-nginx.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apply</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deployment-nginx.yaml</span></span></code></pre></div><p>查看<code>Deployment</code>状态</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">deployments.apps</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-o</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">wide</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                    </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">UP-TO-DATE</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AVAILABLE</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">CONTAINERS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">IMAGES</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">SELECTOR</span></span>
<span class="line"><span style="color:#B392F0;">demo-deployment-nginx</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">10</span><span style="color:#9ECBFF;">/10</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">           </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">9</span><span style="color:#9ECBFF;">m16s</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">demo-nginx</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">nginx</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">app=nginx</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deployments.apps</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-o</span><span style="color:#24292E;"> </span><span style="color:#032F62;">wide</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                    </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">UP-TO-DATE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AVAILABLE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span><span style="color:#24292E;">     </span><span style="color:#032F62;">CONTAINERS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">IMAGES</span><span style="color:#24292E;">   </span><span style="color:#032F62;">SELECTOR</span></span>
<span class="line"><span style="color:#6F42C1;">demo-deployment-nginx</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">10</span><span style="color:#032F62;">/10</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">10</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">10</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">9</span><span style="color:#032F62;">m16s</span><span style="color:#24292E;">   </span><span style="color:#032F62;">demo-nginx</span><span style="color:#24292E;">   </span><span style="color:#032F62;">nginx</span><span style="color:#24292E;">    </span><span style="color:#032F62;">app=nginx</span></span></code></pre></div><p>查看<code>pods</code>状态</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pods</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-o</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">wide</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                                    </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">RESTARTS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">IP</span><span style="color:#E1E4E8;">           </span><span style="color:#9ECBFF;">NODE</span><span style="color:#E1E4E8;">                 </span><span style="color:#9ECBFF;">NOMINATED</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">NODE</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">READINESS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">GATES</span></span>
<span class="line"><span style="color:#B392F0;">demo-deployment-nginx-c598b987f-4qdqh</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">101</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">10.42</span><span style="color:#9ECBFF;">.1.32</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">demo-server-node-3</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">demo-deployment-nginx-c598b987f-89tvw</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">101</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">10.42</span><span style="color:#9ECBFF;">.0.29</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">demo-server-node</span><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">demo-deployment-nginx-c598b987f-bgqlw</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">101</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">10.42</span><span style="color:#9ECBFF;">.1.31</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">demo-server-node-3</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">demo-deployment-nginx-c598b987f-hp692</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">101</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">10.42</span><span style="color:#9ECBFF;">.0.26</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">demo-server-node</span><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">demo-deployment-nginx-c598b987f-kg8fc</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">101</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">10.42</span><span style="color:#9ECBFF;">.0.30</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">demo-server-node</span><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">demo-deployment-nginx-c598b987f-kvk4v</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">101</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">10.42</span><span style="color:#9ECBFF;">.0.27</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">demo-server-node</span><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">demo-deployment-nginx-c598b987f-lg9wc</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">101</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">10.42</span><span style="color:#9ECBFF;">.2.31</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">demo-server-node-2</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">demo-deployment-nginx-c598b987f-nnjkv</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">101</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">10.42</span><span style="color:#9ECBFF;">.0.28</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">demo-server-node</span><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">demo-deployment-nginx-c598b987f-wbnlz</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">101</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">10.42</span><span style="color:#9ECBFF;">.1.35</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">demo-server-node-3</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">demo-deployment-nginx-c598b987f-wmt94</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">101</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">10.42</span><span style="color:#9ECBFF;">.0.31</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">demo-server-node</span><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pods</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-o</span><span style="color:#24292E;"> </span><span style="color:#032F62;">wide</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                                    </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span><span style="color:#24292E;">    </span><span style="color:#032F62;">IP</span><span style="color:#24292E;">           </span><span style="color:#032F62;">NODE</span><span style="color:#24292E;">                 </span><span style="color:#032F62;">NOMINATED</span><span style="color:#24292E;"> </span><span style="color:#032F62;">NODE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">READINESS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">GATES</span></span>
<span class="line"><span style="color:#6F42C1;">demo-deployment-nginx-c598b987f-4qdqh</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">101</span><span style="color:#032F62;">s</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">10.42</span><span style="color:#032F62;">.1.32</span><span style="color:#24292E;">   </span><span style="color:#032F62;">demo-server-node-3</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">demo-deployment-nginx-c598b987f-89tvw</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">101</span><span style="color:#032F62;">s</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">10.42</span><span style="color:#032F62;">.0.29</span><span style="color:#24292E;">   </span><span style="color:#032F62;">demo-server-node</span><span style="color:#24292E;">     </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">demo-deployment-nginx-c598b987f-bgqlw</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">101</span><span style="color:#032F62;">s</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">10.42</span><span style="color:#032F62;">.1.31</span><span style="color:#24292E;">   </span><span style="color:#032F62;">demo-server-node-3</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">demo-deployment-nginx-c598b987f-hp692</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">101</span><span style="color:#032F62;">s</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">10.42</span><span style="color:#032F62;">.0.26</span><span style="color:#24292E;">   </span><span style="color:#032F62;">demo-server-node</span><span style="color:#24292E;">     </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">demo-deployment-nginx-c598b987f-kg8fc</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">101</span><span style="color:#032F62;">s</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">10.42</span><span style="color:#032F62;">.0.30</span><span style="color:#24292E;">   </span><span style="color:#032F62;">demo-server-node</span><span style="color:#24292E;">     </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">demo-deployment-nginx-c598b987f-kvk4v</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">101</span><span style="color:#032F62;">s</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">10.42</span><span style="color:#032F62;">.0.27</span><span style="color:#24292E;">   </span><span style="color:#032F62;">demo-server-node</span><span style="color:#24292E;">     </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">demo-deployment-nginx-c598b987f-lg9wc</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">101</span><span style="color:#032F62;">s</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">10.42</span><span style="color:#032F62;">.2.31</span><span style="color:#24292E;">   </span><span style="color:#032F62;">demo-server-node-2</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">demo-deployment-nginx-c598b987f-nnjkv</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">101</span><span style="color:#032F62;">s</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">10.42</span><span style="color:#032F62;">.0.28</span><span style="color:#24292E;">   </span><span style="color:#032F62;">demo-server-node</span><span style="color:#24292E;">     </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">demo-deployment-nginx-c598b987f-wbnlz</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">101</span><span style="color:#032F62;">s</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">10.42</span><span style="color:#032F62;">.1.35</span><span style="color:#24292E;">   </span><span style="color:#032F62;">demo-server-node-3</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">demo-deployment-nginx-c598b987f-wmt94</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">101</span><span style="color:#032F62;">s</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">10.42</span><span style="color:#032F62;">.0.31</span><span style="color:#24292E;">   </span><span style="color:#032F62;">demo-server-node</span><span style="color:#24292E;">     </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span></code></pre></div><h2 id="卸载" tabindex="-1">卸载 <a class="header-anchor" href="#卸载" aria-label="Permalink to &quot;卸载&quot;">​</a></h2><p>如果需要重新加入另外一个集群或者更改第一个管理节点，最简单的还是先卸载再重装<code>rke2</code>，<code>server</code>和<code>agent</code>节点的卸载是一样的</p><p>在<code>/usr/local/bin/rke2-uninstall.sh</code>或者<code>/usr/bin/rke2-uninstall.sh</code>有可执行的脚本</p><p>确定可执行<code>sh</code>位置后，运行如下命令即可</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/usr/local/bin/rke2-uninstall.sh</span></span>
<span class="line"><span style="color:#6A737D;"># 或者</span></span>
<span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rke2-uninstall.sh</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/usr/local/bin/rke2-uninstall.sh</span></span>
<span class="line"><span style="color:#6A737D;"># 或者</span></span>
<span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rke2-uninstall.sh</span></span></code></pre></div><h2 id="参考阅读" tabindex="-1">参考阅读 <a class="header-anchor" href="#参考阅读" aria-label="Permalink to &quot;参考阅读&quot;">​</a></h2><p><a href="https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/install-kubeadm/" target="_blank" rel="noreferrer"><code>kubeadm</code>部署安装集群</a></p><p><a href="https://github.com/k3s-io/k3s" target="_blank" rel="noreferrer"><code>k3s</code>项目</a></p><p><a href="https://docs.rancher.cn/docs/rke2/_index" target="_blank" rel="noreferrer"><code>rke2</code>官方文档</a></p><p><a href="https://kubernetes.io/zh-cn/docs/tasks/tools/included/optional-kubectl-configs-bash-linux/" target="_blank" rel="noreferrer"><code>kubectl</code>补全</a></p>`,109),e=[p];function c(t,r,y,E,F,i){return n(),a("div",null,e)}const h=s(o,[["render",c]]);export{C as __pageData,h as default};
