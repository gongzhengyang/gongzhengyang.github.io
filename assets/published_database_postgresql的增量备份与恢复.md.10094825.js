import{_ as s,o as a,c as n,Q as p}from"./chunks/framework.36bc40e2.js";const C=JSON.parse('{"title":"postgresql的备份与恢复","description":"","frontmatter":{},"headers":[],"relativePath":"published/database/postgresql的增量备份与恢复.md","filePath":"published/database/postgresql的增量备份与恢复.md","lastUpdated":1700106669000}'),o={name:"published/database/postgresql的增量备份与恢复.md"},l=p(`<h1 id="postgresql的备份与恢复" tabindex="-1"><code>postgresql</code>的备份与恢复 <a class="header-anchor" href="#postgresql的备份与恢复" aria-label="Permalink to &quot;\`postgresql\`的备份与恢复&quot;">​</a></h1><p><code>postgresql</code>的备份恢复方式主要分为三种<code>sql</code>转储，文件系统级别备份，连续归档和时间点恢复，每种备份恢复方式都有其优缺点，实现方式都不太一样。</p><h2 id="测试数据库搭建" tabindex="-1">测试数据库搭建 <a class="header-anchor" href="#测试数据库搭建" aria-label="Permalink to &quot;测试数据库搭建&quot;">​</a></h2><p>新建<code>compose.yaml</code>文件</p><p>采用<code>postgres15</code>版本</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">services</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">postgres</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">postgres:15-bullseye</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">container_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demo-postgres</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">restart</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">always</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">volumes</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#9ECBFF;">demo-postgres-data:/var/lib/postgresql/data</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#9ECBFF;">127.0.0.1:5432:5432</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">environment</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#9ECBFF;">POSTGRES_DB=demo</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#9ECBFF;">POSTGRES_USER=demo</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#9ECBFF;">POSTGRES_PASSWORD=demo-pass</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#9ECBFF;">TZ=Asia/Shanghai</span></span>
<span class="line"></span>
<span class="line"><span style="color:#85E89D;">volumes</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">demo-postgres-data</span><span style="color:#E1E4E8;">: {}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">services</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">postgres</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">postgres:15-bullseye</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">container_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demo-postgres</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">restart</span><span style="color:#24292E;">: </span><span style="color:#032F62;">always</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">volumes</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#032F62;">demo-postgres-data:/var/lib/postgresql/data</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#032F62;">127.0.0.1:5432:5432</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">environment</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#032F62;">POSTGRES_DB=demo</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#032F62;">POSTGRES_USER=demo</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#032F62;">POSTGRES_PASSWORD=demo-pass</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#032F62;">TZ=Asia/Shanghai</span></span>
<span class="line"></span>
<span class="line"><span style="color:#22863A;">volumes</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">demo-postgres-data</span><span style="color:#24292E;">: {}</span></span></code></pre></div><p>启动数据库</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">docker</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">compose</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">up</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-d</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">docker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">compose</span><span style="color:#24292E;"> </span><span style="color:#032F62;">up</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span></span></code></pre></div><p>创建数据库表</p><div class="language-postgresql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">postgresql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">CREATE TABLE public.users (</span></span>
<span class="line"><span style="color:#e1e4e8;">	id serial NOT NULL,</span></span>
<span class="line"><span style="color:#e1e4e8;">	&quot;name&quot; varchar(45) NOT NULL,</span></span>
<span class="line"><span style="color:#e1e4e8;">	age int4 NULL,</span></span>
<span class="line"><span style="color:#e1e4e8;">	&quot;locked&quot; bool NOT NULL DEFAULT false,</span></span>
<span class="line"><span style="color:#e1e4e8;">	created_at timestamp NOT NULL,</span></span>
<span class="line"><span style="color:#e1e4e8;">	CONSTRAINT users_pkey PRIMARY KEY (id)</span></span>
<span class="line"><span style="color:#e1e4e8;">);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">CREATE TABLE public.users (</span></span>
<span class="line"><span style="color:#24292e;">	id serial NOT NULL,</span></span>
<span class="line"><span style="color:#24292e;">	&quot;name&quot; varchar(45) NOT NULL,</span></span>
<span class="line"><span style="color:#24292e;">	age int4 NULL,</span></span>
<span class="line"><span style="color:#24292e;">	&quot;locked&quot; bool NOT NULL DEFAULT false,</span></span>
<span class="line"><span style="color:#24292e;">	created_at timestamp NOT NULL,</span></span>
<span class="line"><span style="color:#24292e;">	CONSTRAINT users_pkey PRIMARY KEY (id)</span></span>
<span class="line"><span style="color:#24292e;">);</span></span></code></pre></div><p>测试插入单条数据</p><div class="language-postgresql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">postgresql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">INSERT INTO users (name, age, created_at) VALUES (&#39;Jim&#39;, 18, NOW());</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">INSERT INTO users (name, age, created_at) VALUES (&#39;Jim&#39;, 18, NOW());</span></span></code></pre></div><p>测试批量写入数据</p><p>通过<code>WHILE i &lt; 5 LOOP </code>的判断语句决定执行次数</p><p>插入数据的<code>name</code>字段通过<code>user</code>前缀拼接一个随机数字写入</p><p><code>age</code>字段也是一个随机整数</p><div class="language-postgresql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">postgresql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">DO $$</span></span>
<span class="line"><span style="color:#e1e4e8;">DECLARE</span></span>
<span class="line"><span style="color:#e1e4e8;">i INTEGER := 1;</span></span>
<span class="line"><span style="color:#e1e4e8;">BEGIN</span></span>
<span class="line"><span style="color:#e1e4e8;">  WHILE i &lt; 5 LOOP </span></span>
<span class="line"><span style="color:#e1e4e8;">    INSERT INTO users (name, age, created_at) VALUES (&#39;user&#39;||round(random()*i*i), round(random()*i), NOW());</span></span>
<span class="line"><span style="color:#e1e4e8;">    i = i + 1;</span></span>
<span class="line"><span style="color:#e1e4e8;">  END LOOP;</span></span>
<span class="line"><span style="color:#e1e4e8;">END $$;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">DO $$</span></span>
<span class="line"><span style="color:#24292e;">DECLARE</span></span>
<span class="line"><span style="color:#24292e;">i INTEGER := 1;</span></span>
<span class="line"><span style="color:#24292e;">BEGIN</span></span>
<span class="line"><span style="color:#24292e;">  WHILE i &lt; 5 LOOP </span></span>
<span class="line"><span style="color:#24292e;">    INSERT INTO users (name, age, created_at) VALUES (&#39;user&#39;||round(random()*i*i), round(random()*i), NOW());</span></span>
<span class="line"><span style="color:#24292e;">    i = i + 1;</span></span>
<span class="line"><span style="color:#24292e;">  END LOOP;</span></span>
<span class="line"><span style="color:#24292e;">END $$;</span></span></code></pre></div><p>最后执行查询语句</p><div class="language-postgresql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">postgresql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">select * from users;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">select * from users;</span></span></code></pre></div><table><thead><tr><th>id</th><th>name</th><th>age</th><th>locked</th><th>created_at</th></tr></thead><tbody><tr><td>1</td><td>Jim</td><td>18</td><td>false</td><td><code>2022-11-18 15:37:22</code></td></tr><tr><td>2</td><td>user0</td><td>0</td><td>false</td><td><code>2022-11-18 15:37:33</code></td></tr><tr><td>3</td><td>user0</td><td>0</td><td>false</td><td><code>2022-11-18 15:37:33</code></td></tr><tr><td>4</td><td>user1</td><td>1</td><td>false</td><td><code>2022-11-18 15:37:33</code></td></tr><tr><td>5</td><td>user13</td><td>0</td><td>false</td><td><code>2022-11-18 15:37:33</code></td></tr></tbody></table><h2 id="sql转储实现" tabindex="-1"><code>sql</code>转储实现 <a class="header-anchor" href="#sql转储实现" aria-label="Permalink to &quot;\`sql\`转储实现&quot;">​</a></h2><ul><li><h4 id="概念逻辑" tabindex="-1">概念逻辑 <a class="header-anchor" href="#概念逻辑" aria-label="Permalink to &quot;概念逻辑&quot;">​</a></h4><ul><li>创建一个由<code>sql</code>命令组成的文件，当把这个文件回馈给服务器时，服务器将利用其中的<code>sql</code>命令重建与转储时状态一样的数据库</li><li>采用<code>pgdump</code>或者<code>pg_dumpall</code>工具，可以远程执行，需要有读取数据表的权限</li><li>转储表现了<code>pg_dump</code>开始运行时刻的数据库快照，在<code>pg_dump</code>运行过程中发生的更新将不会被转储</li><li><code>pg_dump</code>工作的时候并不阻塞其他的对数据库的操作，但是会阻塞那些需要排它锁的操作，比如大部分形式的<code>ALTER TABLE</code></li><li><code>pg_dump</code>实现的<code>sql</code>转储方式，备份和恢复比较简单直接，不大容易遇到什么复杂的问题，由于是整张表或者整个数据库的备份，所以整体资源消耗比较大</li><li>属于热备份，在数据库服务持续运行的情况下备份与恢复</li></ul></li><li><h4 id="备份存储" tabindex="-1">备份存储 <a class="header-anchor" href="#备份存储" aria-label="Permalink to &quot;备份存储&quot;">​</a></h4></li></ul><p>在宿主机上面<code>pg_dump</code>可以采用<code>sudo apt install postgresql-client</code>安装，但是<code>pg_dump</code>如果和<code>docker</code>里面的<code>pg</code>版本对不上的话，执行导出命令会报错如下</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">pg_dump: error: server version: 15.1 (Debian 15.1-1.pgdg110+1); pg_dump version: 14.5 (Ubuntu 14.5-0ubuntu0.22.04.1)</span></span>
<span class="line"><span style="color:#e1e4e8;">pg_dump: error: aborting because of server version mismatch</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">pg_dump: error: server version: 15.1 (Debian 15.1-1.pgdg110+1); pg_dump version: 14.5 (Ubuntu 14.5-0ubuntu0.22.04.1)</span></span>
<span class="line"><span style="color:#24292e;">pg_dump: error: aborting because of server version mismatch</span></span></code></pre></div><p><code>pg_dump</code>是和<code>postgres</code>容器一起封装的，所以可以使用容器内部的工具执行导出命令</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">docker</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">exec</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-it</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo-postgres</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pg_dump</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-h</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">127.0</span><span style="color:#9ECBFF;">.0.1</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-U</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-d</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">5432</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo.sql</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">docker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">exec</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-it</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo-postgres</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pg_dump</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-h</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">127.0</span><span style="color:#032F62;">.0.1</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-U</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5432</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo.sql</span></span></code></pre></div><p>参数解释</p><ul><li><code>-h 127.0.0.1</code>指定使用本地数据库</li><li><code>-U demo</code>指定使用账号<code>demo</code>进行操作</li><li><code>-p 5432</code>指定使用端口<code>5432</code></li><li><code>-d demo</code>指定使用数据库<code>demo</code></li><li><code>-f demo.sql</code>指定输出到文件<code>demo.sql</code></li></ul><p>上面的命令会在容器的根路径下创建一个<code>demo.sql</code>文件</p><p>如果只想转储某几张表的数据，比如<code>users_1</code>和<code>users_2</code>，则需要指定<code>-t</code>参数，可以多次指定，命令可以改为如下</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">docker</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">exec</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-it</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo-postgres</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pg_dump</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-h</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">127.0</span><span style="color:#9ECBFF;">.0.1</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-U</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-d</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">5432</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo.sql</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-t</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">users_1</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-t</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">users_2</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">docker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">exec</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-it</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo-postgres</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pg_dump</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-h</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">127.0</span><span style="color:#032F62;">.0.1</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-U</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5432</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo.sql</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-t</span><span style="color:#24292E;"> </span><span style="color:#032F62;">users_1</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-t</span><span style="color:#24292E;"> </span><span style="color:#032F62;">users_2</span></span></code></pre></div><p>现在需要把该文件从容器内部复制出来</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">docker</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cp</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo-postgres:/demo.sql</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">.</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">docker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cp</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo-postgres:/demo.sql</span><span style="color:#24292E;"> </span><span style="color:#032F62;">.</span></span></code></pre></div><p>导出的<code>demo.sql</code>包含了数据库<code>demo</code>里面的表<code>users</code>的<code>sql</code>创建语句以及该表关联的<code>SEQUENCE</code>（<code>users_id_seq</code>）的创建语句，<code>users</code>表数据的写入语句</p><ul><li><h4 id="数据恢复" tabindex="-1">数据恢复 <a class="header-anchor" href="#数据恢复" aria-label="Permalink to &quot;数据恢复&quot;">​</a></h4></li></ul><p>现在执行<code>sql</code>命令清空数据表<code>users</code></p><div class="language-postgresql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">postgresql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">truncate users ;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">truncate users ;</span></span></code></pre></div><p>执行数据恢复命令，该命令和导出命令是非常类似的，各个参数都一样，只是执行的命令从<code>pg_dump</code>转变为<code>psql</code></p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">docker</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">exec</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-it</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo-postgres</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">psql</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-h</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">127.0</span><span style="color:#9ECBFF;">.0.1</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-U</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-d</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">5432</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo.sql</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">docker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">exec</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-it</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo-postgres</span><span style="color:#24292E;"> </span><span style="color:#032F62;">psql</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-h</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">127.0</span><span style="color:#032F62;">.0.1</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-U</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5432</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo.sql</span></span></code></pre></div><p>命令执行的输出有些报错，比如类似下面的，主要是由于导出命令包含了数据表创建语句，<code>Sequence</code>创建语句，主键创建语句，由于在执行的时候没有检测是否存在对应的对象，整个<code>sql</code>文件在执行的时候没有被包含在一个事务当中，所以创建数据表的语句是执行失败的，数据导入是成功的</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">psql:demo.sql:33: ERROR:  relation &quot;users&quot; already exists</span></span>
<span class="line"><span style="color:#e1e4e8;">ALTER TABLE</span></span>
<span class="line"><span style="color:#e1e4e8;">psql:demo.sql:48: ERROR:  relation &quot;users_id_seq&quot; already exists</span></span>
<span class="line"><span style="color:#e1e4e8;">ALTER TABLE</span></span>
<span class="line"><span style="color:#e1e4e8;">ALTER SEQUENCE</span></span>
<span class="line"><span style="color:#e1e4e8;">ALTER TABLE</span></span>
<span class="line"><span style="color:#e1e4e8;">COPY 5</span></span>
<span class="line"><span style="color:#e1e4e8;"> setval </span></span>
<span class="line"><span style="color:#e1e4e8;">--------</span></span>
<span class="line"><span style="color:#e1e4e8;">      5</span></span>
<span class="line"><span style="color:#e1e4e8;">(1 row)</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">psql:demo.sql:92: ERROR:  multiple primary keys for table &quot;users&quot; are not allowed</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">psql:demo.sql:33: ERROR:  relation &quot;users&quot; already exists</span></span>
<span class="line"><span style="color:#24292e;">ALTER TABLE</span></span>
<span class="line"><span style="color:#24292e;">psql:demo.sql:48: ERROR:  relation &quot;users_id_seq&quot; already exists</span></span>
<span class="line"><span style="color:#24292e;">ALTER TABLE</span></span>
<span class="line"><span style="color:#24292e;">ALTER SEQUENCE</span></span>
<span class="line"><span style="color:#24292e;">ALTER TABLE</span></span>
<span class="line"><span style="color:#24292e;">COPY 5</span></span>
<span class="line"><span style="color:#24292e;"> setval </span></span>
<span class="line"><span style="color:#24292e;">--------</span></span>
<span class="line"><span style="color:#24292e;">      5</span></span>
<span class="line"><span style="color:#24292e;">(1 row)</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">psql:demo.sql:92: ERROR:  multiple primary keys for table &quot;users&quot; are not allowed</span></span></code></pre></div><p>为了避免数据恢复时候的某些语句报错，可以在导出数据的时候增加一个参数<code>-a</code>或者<code>--data-only</code>，这样在生成的<code>sql</code>语句就不包含了数据表相关的创建语句</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">docker</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">exec</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-it</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo-postgres</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pg_dump</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-h</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">127.0</span><span style="color:#9ECBFF;">.0.1</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-U</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-d</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">5432</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo.sql</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-a</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">docker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">exec</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-it</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo-postgres</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pg_dump</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-h</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">127.0</span><span style="color:#032F62;">.0.1</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-U</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5432</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo.sql</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-a</span></span></code></pre></div><h2 id="文件系统级别备份实现" tabindex="-1">文件系统级别备份实现 <a class="header-anchor" href="#文件系统级别备份实现" aria-label="Permalink to &quot;文件系统级别备份实现&quot;">​</a></h2><ul><li><h4 id="概念逻辑-1" tabindex="-1">概念逻辑 <a class="header-anchor" href="#概念逻辑-1" aria-label="Permalink to &quot;概念逻辑&quot;">​</a></h4><ul><li>冷备份，为了得到一个可用的备份，数据库服务器必须被关闭，在恢复数据之前你也需要关闭服务器</li><li>文件系统备份值适合于完整地备份或恢复整个数据库集簇</li><li>一个文件系统备份通常会比一个<code>sql</code>转储体积更大</li><li>官网文档原话说<code>这种方法不实用，或者说至少比pg_dump方法差</code>(<code>however, which make this method impractical, or at least inferior to the pg_dump method</code>)</li><li>实际操作过程当中感觉虽然操作不复杂，但是感觉容易出问题，如果在执行备份或者恢复过程当中忘记关闭数据库的话，一不小心可能就是文件损坏或者数据丢失了，尽量不要使用这个方案</li></ul></li><li><h4 id="备份存储-1" tabindex="-1">备份存储 <a class="header-anchor" href="#备份存储-1" aria-label="Permalink to &quot;备份存储&quot;">​</a></h4></li></ul><p>由于目前测试的数据库是采用<code>docker</code>容器启动的，但是存储位置被挂载出来了</p><p>先关闭<code>docker</code>，执行命令如下</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">$ docker compose down</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">$ docker compose down</span></span></code></pre></div><p>由于我们<code>compose.yaml</code>文件的所在文件夹的名称是<code>pg-backup</code>，同时<code>compose.yaml</code>文件当中包含如下数据，<code>docker</code>容器中的<code>postgres</code>默认输出存储位置是<code>/var/lib/postgresql/data</code>，如果是直接安装在宿主机上面，数据存储位置可能是<code>/usr/local/pgsql/data</code></p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">volumes</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">demo-postgres-data:/var/lib/postgresql/data</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">volumes</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">demo-postgres-data:/var/lib/postgresql/data</span></span></code></pre></div><p>所以数据存储在宿主机位置</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">/var/lib/docker/volumes/pg-backup_demo-postgres-data/_data</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">/var/lib/docker/volumes/pg-backup_demo-postgres-data/_data</span></span></code></pre></div><p>执行备份命令</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">sudo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">tar</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-cf</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">backup.tar</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/var/lib/docker/volumes/pg-backup_demo-postgres-data/_data</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">sudo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">tar</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-cf</span><span style="color:#24292E;"> </span><span style="color:#032F62;">backup.tar</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/var/lib/docker/volumes/pg-backup_demo-postgres-data/_data</span></span></code></pre></div><p>如果执行报错的话，比如报错如下</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">tar: 从成员名中删除开头的“/”</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">tar: 从成员名中删除开头的“/”</span></span></code></pre></div><p>需要<code>cd</code>到根目录下面</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cd</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/</span></span>
<span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">tar</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-cf</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">backup.tar</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">var/lib/docker/volumes/pg-backup_demo-postgres-data/_data</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cd</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/</span></span>
<span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">tar</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-cf</span><span style="color:#24292E;"> </span><span style="color:#032F62;">backup.tar</span><span style="color:#24292E;"> </span><span style="color:#032F62;">var/lib/docker/volumes/pg-backup_demo-postgres-data/_data</span></span></code></pre></div><ul><li><h4 id="数据恢复-1" tabindex="-1">数据恢复 <a class="header-anchor" href="#数据恢复-1" aria-label="Permalink to &quot;数据恢复&quot;">​</a></h4></li></ul><p>如果<code>backup.tar</code>文件是保存在根目录下面(<code>/</code>)的，在停止服务器的情况下，在根目录下执行（需要慎重）</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">tar</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-xf</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">backup.tar</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">tar</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-xf</span><span style="color:#24292E;"> </span><span style="color:#032F62;">backup.tar</span></span></code></pre></div><h2 id="连续归档和时间点恢复实现" tabindex="-1">连续归档和时间点恢复实现 <a class="header-anchor" href="#连续归档和时间点恢复实现" aria-label="Permalink to &quot;连续归档和时间点恢复实现&quot;">​</a></h2><p>连续归档备份与恢复的操作实现中，官方文档给出的实际操作中比较偏向于底层实现逻辑，比较繁琐，所以在连续归档的实现上适合引入第三方的备份回复项目用于实现该目的。</p><p>推荐两个开源项目，<a href="https://pgbackrest.org/user-guide.html" target="_blank" rel="noreferrer"><code>pgbackrest</code></a>（基于<code>C</code>语言开发）和<a href="https://github.com/wal-g/wal-g" target="_blank" rel="noreferrer"><code>wal-g</code></a>（基于<code>golang</code>开发），二者的实现逻辑是很类似的，在使用过程当中，<code>pgbackrest</code>的文档写的更详细，从基本的工具使用上，发现<code>wal-g</code>操作上报错信息比较难以定位问题，<code>wal-g</code>也没有给出一个比较完整的操作说明，使得很多操作需要依靠自行搜索第三方说明文档（第三方文档的质量也一言难尽）或者去直接猜测，后面可能这个情况会有好转，毕竟<code>wal-g</code>在<code>github</code>上面的<code>star</code>数量还是蛮多的</p><p>所以下面主要使用<code>pgbackrest</code>，<code>minio</code>对象存储作为备份数据的仓库</p><h4 id="概念逻辑-2" tabindex="-1">概念逻辑 <a class="header-anchor" href="#概念逻辑-2" aria-label="Permalink to &quot;概念逻辑&quot;">​</a></h4><ul><li>热备份，可以把一个文件系统级别的备份和<code>WAL</code>文件的备份结合起来，当需要恢复时，我们先恢复文件系统备份，然后从备份的<code>WAL</code>文件中重放来把系统带到一个当前状态</li><li>数据集簇目录的<code>pg_wal/</code>子目录下都保持有一个<em>预写式日志</em><code>WAL</code>，为了保证崩溃后的安全，确保没有提交的更改丢失的机制，事务按顺序写入 <code>WAL</code>，当这些写入刷新到磁盘时，事务被视为已提交之后，后台进程将更改写入主数据库集群文件（也称为堆），如果发生崩溃，<code>WAL</code> 将被重放以使数据库保持一致，<code>WAL</code> 在概念上是无限的，但实际上被分解成称为段的单个 <code>16MB</code> (默认大小)文件，<code> WAL</code> 段遵循命名约定 <code>0000000100000A1E000000FE</code>，其中前 8 位十六进制数字表示时间线，接下来的 16 位数字是逻辑序列号 (<code>LSN</code>)</li><li>这种方法只能支持整个数据库集簇的恢复</li></ul><h4 id="备份类型" tabindex="-1">备份类型 <a class="header-anchor" href="#备份类型" aria-label="Permalink to &quot;备份类型&quot;">​</a></h4><ul><li><p>完整备份(<code>Full Backup</code>)</p><p><code>pgBackRest </code>将数据库集群的全部内容复制到备份中，数据库集群的第一次备份始终是完整备份，<code>pgBackRest</code> 始终能够直接恢复完整备份，完整备份不依赖于完整备份之外的任何文件以保持一致性</p></li><li><p>差异备份(<code>Differential Backup</code>)</p><p><code>pgBackRest</code> 仅复制自上次完整备份以来发生更改的那些数据库集群文件，<code>pgBackRest</code> 通过复制所选差异备份中的所有文件和先前完整备份中适当的未更改文件来恢复差异备份，差异备份的优点是它比完整备份需要更少的磁盘空间，但是差异备份和完整备份必须都有效才能恢复差异备份</p></li><li><p>增量备份(<code>Incremental Backup</code>)</p><p><code>pgBackRest</code> 仅复制自上次备份（可以是另一个增量备份、差异备份或完整备份）以来发生更改的那些数据库集群文件，由于增量备份仅包括自上次备份以来更改的文件，因此它们通常比完整备份或差异备份小得多，与差异备份一样，增量备份依赖于其他有效的备份来恢复增量备份，由于增量备份仅包括自上次备份以来的那些文件，因此所有之前的增量备份回到之前的差异、之前的差异备份和之前的完整备份都必须有效才能执行增量备份的恢复，如果不存在差异备份，则所有先前的增量备份都将返回到先前的完整备份，该完整备份必须存在，并且完整备份本身必须有效才能恢复增量备份</p></li></ul><h4 id="备份与恢复逻辑流程" tabindex="-1">备份与恢复逻辑流程 <a class="header-anchor" href="#备份与恢复逻辑流程" aria-label="Permalink to &quot;备份与恢复逻辑流程&quot;">​</a></h4><ul><li>创建<code>pgbackrest</code>的配置文件</li><li>创建<code>postgres.conf</code>自定义配置文件</li><li>创建<code>Dockerfile</code>重新打包镜像</li><li>创建<code>compose.yaml</code>文件编排容器</li><li>增加<code>minio</code>对象存储作为数据备份仓库，使用<code>mkcert</code>创建自签名证书使得<code>minio</code>使用<code>https</code>(<code>pgbackrest</code>远程备份仓库只使用<code>https</code>传输数据，没找到配置可以改成<code>http</code>)，<code>pgbackrest</code>支持<code>Azure</code>，<code>GCS</code>,<code>Amazon S3</code>存储，<code>minio</code>对象存储兼容<code>S3</code>协议，所以采用该对象存储</li><li>执行<code>stanza</code>创建命令，检查备份状态</li><li>测试验证恢复数据</li></ul><h4 id="pgbackrest配置" tabindex="-1"><code>pgbackrest</code>配置 <a class="header-anchor" href="#pgbackrest配置" aria-label="Permalink to &quot;\`pgbackrest\`配置&quot;">​</a></h4><p>新建文件<code>pgbackrest.conf</code></p><div class="language-ini vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ini</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">[demo]</span></span>
<span class="line"><span style="color:#F97583;">pg1-path</span><span style="color:#E1E4E8;">=/var/lib/postgresql/data</span></span>
<span class="line"><span style="color:#F97583;">pg1-user</span><span style="color:#E1E4E8;">=demo</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">[global]</span></span>
<span class="line"><span style="color:#F97583;">repo1-cipher-pass</span><span style="color:#E1E4E8;">=zWaf6XtpjIVZC5444yXB+cgFDFl7MxGlgkZSaoPvTGirhPygu4jOKOXf9LO4vjfO</span></span>
<span class="line"><span style="color:#F97583;">repo1-cipher-type</span><span style="color:#E1E4E8;">=aes-256-cbc</span></span>
<span class="line"><span style="color:#F97583;">repo1-path</span><span style="color:#E1E4E8;">=/test-back</span></span>
<span class="line"><span style="color:#F97583;">repo1-retention-full</span><span style="color:#E1E4E8;">=2</span></span>
<span class="line"><span style="color:#F97583;">repo1-s3-bucket</span><span style="color:#E1E4E8;">=file-bucket</span></span>
<span class="line"><span style="color:#F97583;">repo1-s3-endpoint</span><span style="color:#E1E4E8;">=minio:9000</span></span>
<span class="line"><span style="color:#F97583;">repo1-s3-key</span><span style="color:#E1E4E8;">=miniouser</span></span>
<span class="line"><span style="color:#F97583;">repo1-s3-key-secret</span><span style="color:#E1E4E8;">=miniopass</span></span>
<span class="line"><span style="color:#F97583;">repo1-s3-uri-style</span><span style="color:#E1E4E8;">=path</span></span>
<span class="line"><span style="color:#F97583;">repo1-s3-region</span><span style="color:#E1E4E8;">=us-east-1</span></span>
<span class="line"><span style="color:#F97583;">repo1-storage-verify-tls</span><span style="color:#E1E4E8;">=n</span></span>
<span class="line"><span style="color:#F97583;">repo1-type</span><span style="color:#E1E4E8;">=s3</span></span>
<span class="line"><span style="color:#F97583;">start-fast</span><span style="color:#E1E4E8;">=y</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">[global:archive-push]</span></span>
<span class="line"><span style="color:#F97583;">compress-level</span><span style="color:#E1E4E8;">=3</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">[demo]</span></span>
<span class="line"><span style="color:#D73A49;">pg1-path</span><span style="color:#24292E;">=/var/lib/postgresql/data</span></span>
<span class="line"><span style="color:#D73A49;">pg1-user</span><span style="color:#24292E;">=demo</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">[global]</span></span>
<span class="line"><span style="color:#D73A49;">repo1-cipher-pass</span><span style="color:#24292E;">=zWaf6XtpjIVZC5444yXB+cgFDFl7MxGlgkZSaoPvTGirhPygu4jOKOXf9LO4vjfO</span></span>
<span class="line"><span style="color:#D73A49;">repo1-cipher-type</span><span style="color:#24292E;">=aes-256-cbc</span></span>
<span class="line"><span style="color:#D73A49;">repo1-path</span><span style="color:#24292E;">=/test-back</span></span>
<span class="line"><span style="color:#D73A49;">repo1-retention-full</span><span style="color:#24292E;">=2</span></span>
<span class="line"><span style="color:#D73A49;">repo1-s3-bucket</span><span style="color:#24292E;">=file-bucket</span></span>
<span class="line"><span style="color:#D73A49;">repo1-s3-endpoint</span><span style="color:#24292E;">=minio:9000</span></span>
<span class="line"><span style="color:#D73A49;">repo1-s3-key</span><span style="color:#24292E;">=miniouser</span></span>
<span class="line"><span style="color:#D73A49;">repo1-s3-key-secret</span><span style="color:#24292E;">=miniopass</span></span>
<span class="line"><span style="color:#D73A49;">repo1-s3-uri-style</span><span style="color:#24292E;">=path</span></span>
<span class="line"><span style="color:#D73A49;">repo1-s3-region</span><span style="color:#24292E;">=us-east-1</span></span>
<span class="line"><span style="color:#D73A49;">repo1-storage-verify-tls</span><span style="color:#24292E;">=n</span></span>
<span class="line"><span style="color:#D73A49;">repo1-type</span><span style="color:#24292E;">=s3</span></span>
<span class="line"><span style="color:#D73A49;">start-fast</span><span style="color:#24292E;">=y</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">[global:archive-push]</span></span>
<span class="line"><span style="color:#D73A49;">compress-level</span><span style="color:#24292E;">=3</span></span></code></pre></div><ul><li><p><code>[demo]</code>: 配置<code>stanza</code>的名称，<code>stanza</code>(节)是数据库集群的配置，它定义了它的位置、备份方式、归档选项等，大多数数据库服务器只有一个 <code>postgres</code>数据库集群，因此只有一个节，而备份服务器将有一个需要备份的每个数据库集群的<code>stanza</code></p></li><li><p><code>pg1-path</code>: 指定<code>postgres</code>的数据存储位置</p></li><li><p><code>pg1-user</code>: 指定<code>postgres</code>备用数据所使用的用户名称</p></li><li><p><code>repo1-cipher-pass</code>和<code>repo1-cipher-type</code>：表示使用备份仓库加密，确保备份数据的安全，加密参数<code>repo1-cipher-pass</code>的数据是使用命令<code>openssl rand -base64 48</code>随机生成的，<code>repo1-cipher-type</code>指定了加密类型</p></li><li><p><code>repo1-path</code>: 表示备份的存储位置，如果使用远程对象存储备份的话，该参数用于在存储桶中的位置，如果不配置，则文件会存储在<code>bucket</code>下面，如果配置为<code>test-back</code>，则文件会存储在<code>bucket</code>的<code>test-back</code>文件夹下面</p></li><li><p><code>repo1-retention-full</code>: 表示最多保留两个全量备份，超过的这个数量的旧的全量备份会被清理</p></li><li><p><code>repo1-s3-bucket</code>：声明<code>s3</code>的存储桶的名称，<strong>该存储桶需要在<code>minio</code>服务启动之后访问控制页面手动创建</strong></p></li><li><p><code>repo1-s3-endpoint</code>: 指定<code>s3</code>服务的访问地址，由于是使用<code>docker compose</code>方式部署，所以在<code>postgres</code>容器内部可以使用<code>minio:9000</code>访问对象存储</p></li><li><p><code>repo1-s3-key</code>和<code>repo1-s3-key-secret</code>: 表示对象存储的账号密码</p></li><li><p><code>repo1-s3-uri-style</code>: 可选项是<code>host</code>和<code>path</code></p><ul><li><code>host</code>: 默认选项，表示拼接<code>bucket</code>和<code>endpoint</code>的参数，把域名修改为<code>{bucket}.{endpoint}</code>，详情参考<a href="http://docs.aws.amazon.com/AmazonS3/latest/dev/VirtualHosting.html" target="_blank" rel="noreferrer"><code>Amazon S3: Virtual Hosting of Buckets</code></a>，如果配置为这个参数，会导致服务<code>minio</code>地址无法访问，该类型的访问地址形式是<code>http://{BUCKET}.s3.amazonaws.com/{KEY}</code></li><li><code>path</code>: 表示使用<code>endpoint</code>参数和<code>bucket</code>的信息到<code>url</code>中，访问地址形式变为<code>http://s3.amazonaws.com/{BUCKET}/{KEY}</code></li></ul></li><li><p><code>repo1-s3-region</code>：配置<code>s3</code>区域的信息</p></li><li><p><code>repo1-storage-verify-tls</code>: 由于<code>minio</code>服务的<code>https</code>使用自签名证书，所以证书校验是不安全的，所以该参数需要设置为<code>n</code></p></li><li><p><code>repo1-type</code>: 指定使用<code>s3</code>存储，可选项是</p><ul><li><code>azure</code> - <code>Azure Blob Storage Service</code></li><li><code>cifs</code> - <code>Like posix, but disables links and directory fsyncs</code></li><li><code>gcs</code> - <code>Google Cloud Storage</code></li><li><code>posix </code>- <code>Posix-compliant file systems</code></li><li><code>s3</code> - <code>AWS Simple Storage Service</code></li></ul></li><li><p><code>start-fast=y</code>: 默认情况下，<code>pgBackRest</code> 将在开始备份之前等待<code>postgres</code>服务下一个定期安排的检查点，检查点完成和备份开始之前可能需要相当长的时间，所以最好设置start-fast=y，这样会触发<code>postgres</code>强制执行检查点，但由于备份频率不高，因此额外的检查点不会对性能产生明显影响，如果数据负载一直很高，需要更加需求使用这个命令</p></li><li><p><code>compress-level=3</code>: 可以设置较低的压缩级别来加速<code>archive-push</code>命令的归档</p></li></ul><h4 id="创建自签名证书" tabindex="-1">创建自签名证书 <a class="header-anchor" href="#创建自签名证书" aria-label="Permalink to &quot;创建自签名证书&quot;">​</a></h4><p>采用<code>mkcert</code>开源项目创建证书，<code>BSD-3</code>协议，<code>golang</code>编写，<code>github</code>目前<code>star</code>有<code>38.5k+</code>，项目地址<code>https://github.com/FiloSottile/mkcert</code></p><p>安装依赖</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">sudo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">apt</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">libnss3-tools</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">sudo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apt</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">libnss3-tools</span></span></code></pre></div><p>安装</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">sudo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">apt</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">mkcert</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">sudo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apt</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">mkcert</span></span></code></pre></div><p>创建一个文件夹<code>certs</code>，在这个文件夹当中执行命令</p><p>指定私钥为<code>private.key</code>, 指定证书文件为<code>public.crt</code>,</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">mkcert</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-key-file</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">private.key</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-cert-file</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">public.crt</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">localhost</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">mkcert</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-key-file</span><span style="color:#24292E;"> </span><span style="color:#032F62;">private.key</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-cert-file</span><span style="color:#24292E;"> </span><span style="color:#032F62;">public.crt</span><span style="color:#24292E;"> </span><span style="color:#032F62;">localhost</span></span></code></pre></div><h4 id="镜像制作与部署" tabindex="-1">镜像制作与部署 <a class="header-anchor" href="#镜像制作与部署" aria-label="Permalink to &quot;镜像制作与部署&quot;">​</a></h4><p>软件存在于 <a href="https://www.postgresql.org/download/linux/ubuntu/" target="_blank" rel="noreferrer"><code>apt.postgresql.org</code></a>，所以可以直接<code>apt</code>安装</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">sudo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">apt</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pgbackrest</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">sudo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apt</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pgbackrest</span></span></code></pre></div><p>由于我们的<code>postgresql</code>服务镜像没有包含该软件，所以需要重新构建一个镜像</p><p>新增<code>.dockerignore</code></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">.idea/</span></span>
<span class="line"><span style="color:#e1e4e8;">.git/</span></span>
<span class="line"><span style="color:#e1e4e8;">certs/</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">.idea/</span></span>
<span class="line"><span style="color:#24292e;">.git/</span></span>
<span class="line"><span style="color:#24292e;">certs/</span></span></code></pre></div><p>新增一个<code>Dockerfile</code>文件</p><p>需要先下载<code>CA</code>确保可以使用国内源，最后使用国内源下载加快速度</p><div class="language-dockerfile vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">dockerfile</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> postgres:15-bullseye</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">RUN</span><span style="color:#E1E4E8;"> apt update \\</span></span>
<span class="line"><span style="color:#E1E4E8;">    &amp;&amp; apt install ca-certificates -y \\</span></span>
<span class="line"><span style="color:#E1E4E8;">    &amp;&amp; sed -i </span><span style="color:#9ECBFF;">&quot;s#http://deb.debian.org#https://mirrors.ustc.edu.cn#g&quot;</span><span style="color:#E1E4E8;">  /etc/apt/sources.list \\</span></span>
<span class="line"><span style="color:#E1E4E8;">    &amp;&amp; apt update \\</span></span>
<span class="line"><span style="color:#E1E4E8;">    &amp;&amp; apt install pgbackrest -y \\</span></span>
<span class="line"><span style="color:#E1E4E8;">    &amp;&amp; rm -rf /var/lib/apt/lists/ /var/cache/apt/</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> postgres:15-bullseye</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">RUN</span><span style="color:#24292E;"> apt update \\</span></span>
<span class="line"><span style="color:#24292E;">    &amp;&amp; apt install ca-certificates -y \\</span></span>
<span class="line"><span style="color:#24292E;">    &amp;&amp; sed -i </span><span style="color:#032F62;">&quot;s#http://deb.debian.org#https://mirrors.ustc.edu.cn#g&quot;</span><span style="color:#24292E;">  /etc/apt/sources.list \\</span></span>
<span class="line"><span style="color:#24292E;">    &amp;&amp; apt update \\</span></span>
<span class="line"><span style="color:#24292E;">    &amp;&amp; apt install pgbackrest -y \\</span></span>
<span class="line"><span style="color:#24292E;">    &amp;&amp; rm -rf /var/lib/apt/lists/ /var/cache/apt/</span></span></code></pre></div><p>修改<code>compose.yaml</code>文件如下</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">services</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">postgres</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># image: postgres:15-bullseye</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demo-postgres</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">command</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">postgres -c archive_mode=on -c archive_command=&#39;pgbackrest --stanza=demo archive-push %p&#39; -c archive_timeout=30</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">container_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demo-postgres</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">restart</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">always</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">volumes</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#9ECBFF;">demo-postgres-data:/var/lib/postgresql/data</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#9ECBFF;">./pgbackrest.conf:/etc/pgbackrest/pgbackrest.conf</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#9ECBFF;">127.0.0.1:5433:5432</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">environment</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#9ECBFF;">POSTGRES_DB=demo</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#9ECBFF;">POSTGRES_USER=demo</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#9ECBFF;">POSTGRES_PASSWORD=demo-pass</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#9ECBFF;">TZ=Asia/Shanghai</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">minio</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">minio/minio</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">command</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">server /data --console-address &quot;:9002&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">restart</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">always</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">container_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demo-minio</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">environment</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#9ECBFF;">MINIO_ROOT_USER=miniouser</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#9ECBFF;">MINIO_ROOT_PASSWORD=miniopass</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">volumes</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#9ECBFF;">demo-minio:/data</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#9ECBFF;">./certs:/root/.minio/certs</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#9ECBFF;">9002:9002</span></span>
<span class="line"></span>
<span class="line"><span style="color:#85E89D;">volumes</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">demo-postgres-data</span><span style="color:#E1E4E8;">: {}</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">demo-minio</span><span style="color:#E1E4E8;">: {}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">services</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">postgres</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;"># image: postgres:15-bullseye</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demo-postgres</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">command</span><span style="color:#24292E;">: </span><span style="color:#032F62;">postgres -c archive_mode=on -c archive_command=&#39;pgbackrest --stanza=demo archive-push %p&#39; -c archive_timeout=30</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">container_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demo-postgres</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">restart</span><span style="color:#24292E;">: </span><span style="color:#032F62;">always</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">volumes</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#032F62;">demo-postgres-data:/var/lib/postgresql/data</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#032F62;">./pgbackrest.conf:/etc/pgbackrest/pgbackrest.conf</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#032F62;">127.0.0.1:5433:5432</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">environment</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#032F62;">POSTGRES_DB=demo</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#032F62;">POSTGRES_USER=demo</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#032F62;">POSTGRES_PASSWORD=demo-pass</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#032F62;">TZ=Asia/Shanghai</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">minio</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">minio/minio</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">command</span><span style="color:#24292E;">: </span><span style="color:#032F62;">server /data --console-address &quot;:9002&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">restart</span><span style="color:#24292E;">: </span><span style="color:#032F62;">always</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">container_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demo-minio</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">environment</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#032F62;">MINIO_ROOT_USER=miniouser</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#032F62;">MINIO_ROOT_PASSWORD=miniopass</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">volumes</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#032F62;">demo-minio:/data</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#032F62;">./certs:/root/.minio/certs</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#032F62;">9002:9002</span></span>
<span class="line"></span>
<span class="line"><span style="color:#22863A;">volumes</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">demo-postgres-data</span><span style="color:#24292E;">: {}</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">demo-minio</span><span style="color:#24292E;">: {}</span></span></code></pre></div><h4 id="postgres启动命令" tabindex="-1"><code>postgres</code>启动命令 <a class="header-anchor" href="#postgres启动命令" aria-label="Permalink to &quot;\`postgres\`启动命令&quot;">​</a></h4><ul><li><code>wal_level = replica</code>: <code>wal_level</code>的级别决定了多少信息会被写入<code>wal</code>日志文件中，默认是<code>replica</code>，该参数只能在服务器启动的时候配置 <ul><li><code>minimal</code>: 会去掉除从崩溃或者立即关机中进行恢复所需的信息之外的所有记录，对于创建或重写永久关系的事务的其余部分，不会记录任何信息，不会包括足够的信息来从基础备份和 <code>WAL</code> 日志中重建数据，要启用 <code>WAL</code> 归档或者流复制，必须使用<code>replica</code>或更高级别（<code>logical</code>）</li><li><code>replica</code>: 它会写入足够的数据以支持<code>wal</code>归档和复制，包括在后备服务器上运行只读查询</li><li><code>logical</code>: 与<code>replica</code>相同的信息会被记录，外加上允许从 <code>WAL</code> 抽取逻辑修改集所需的信息，配置该参数会导致<code>wal</code>日志文件增长更快</li><li><code>archive</code>或<code>hot_standby</code>: 在<code>9.6</code>之前的版本中可以使用，现在这些参数会被映射为<code>replica</code></li></ul></li><li><code>archive_mode</code>：可选项<code>off</code>(默认), <code>on</code>, <code>always</code><ul><li>当<code>wal_level</code>被设置为<code>minimal</code>时，<code>archive_mode</code>不能被启用</li><li><code>off</code>: 关闭归档</li><li><code>on</code>: 配置的<code>archive_command</code>命令将完成的<code>WAL</code>段发送到归档存储</li><li><code>always</code>: <code>WAL</code>归档器在归档恢复或者后备模式下也会被启用，所有从归档恢复 的或者用流复制传来的文件将被（再次）归档</li></ul></li><li><code>archive_command</code><ul><li>本地 <code>shell</code> 命令被执行来归档一个完成的 <code>WAL</code> 文件段，默认是空</li><li>如果<code>archive_mode</code>是<code>off</code>，该命令无效</li><li><code>pgbackrest --stanza=demo archive-push %p</code>表示使用<code>pgbackrest</code>的程序，只备份<code>stanza</code>为<code>demo</code>的数据，该参数对应<code>pgbackrest.conf</code>文件当中的<code>[demo]</code>参数信息，<code>archive-push</code>是<code>pgbackrest</code>的一个子命令，会把一个指定的<code>wal</code>段文件发送到归档，<code>%p</code>是 <code>PostgreSQL</code> 指定要归档的 <code>WAL</code> 段位置的方式，默认的当前位置是<code>postgres</code>的数据存放路径（比如<code>/var/lib/postgresql/data</code>）,<code>%p</code>参数的值类似<code>pg_wal/00000001000000000000001F</code>，表明生成的一个<code>wal</code>文件的位置是<code>/var/lib/postgresql/data/pg_wal/00000001000000000000001F</code></li></ul></li><li><code>archive_timeout</code><ul><li>由于归档命令只在已经完成<code>wal</code>段上调用，如果服务器上面的更新操作比较少，那么事务完成之后，这个操作被纪录到归档存储之间有一个很大的延迟，所以为了进行测试数据按照时间点恢复的功能，目前把该参数调整为一个较小的数字，实际生产环境上需要把该参数配置为60或者更大，单位是秒</li><li>这个参数是服务器来周期性地切换到一个新的 <code>WAL</code> 段文件，设置为大于零时，只要从上次段文件切换后过了参数所设置的时间量，并且已经有过任何数据库活动（包括一个单一检查点），服务器将切换到一个新的段文件</li><li>由于强制切换而提早关闭的被归档文件仍然与完整的归档文件长度相同，所以该参数的配置会导致归档存储的磁盘消耗变多</li><li>这个参数是很有必要的，比如现在数据库新增了几条数据，在经过了<code>archive_timeout</code>的时长之后，<code>wal</code>段完成，之后进行<code>pgbackrest</code>备份命令，归档备份被传输到<code>minio</code>仓库，之后才可以运行按照时间点恢复（<strong>即恢复的时间点必须小于最新的被归档的<code>wal</code>日志段</strong>）</li></ul></li></ul><h4 id="minio部分" tabindex="-1"><code>minio</code>部分 <a class="header-anchor" href="#minio部分" aria-label="Permalink to &quot;\`minio\`部分&quot;">​</a></h4><ul><li><p>启动命令和文件挂载需要注意</p></li><li><p>自签名证书需要挂载到<code>minio</code>的对应位置，服务在启动的时候会自动使用<code>https</code></p></li><li><p><code>environment</code>: 配置<code>minio</code>的账号密码，目前旧的环境变量<code>MINIO_ACCESS_KEY</code>和<code>MINIO_SECRET_KEY</code>还是可以使用的，运行的时候会产生告警<code>WARNING:MINIO_ACCESS_KEY and MINIO_SECRET_KEY are deprecated. Please use MINIO_ROOT_USER and MINIO_ROOT_PASSWORD</code></p></li><li><p><code>--console-address &quot;:9002&quot;</code>参数表示开启页面访问，由于挂载了证书，所以访问<code>https://127.0.0.1:9002</code>可以访问<code>minio</code></p></li></ul><p>现在整个项目的配置和文件树如下</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">.</span></span>
<span class="line"><span style="color:#e1e4e8;">├── certs</span></span>
<span class="line"><span style="color:#e1e4e8;">│   ├── private.key</span></span>
<span class="line"><span style="color:#e1e4e8;">│   └── public.crt</span></span>
<span class="line"><span style="color:#e1e4e8;">├── .dockerignore</span></span>
<span class="line"><span style="color:#e1e4e8;">├── compose.yaml</span></span>
<span class="line"><span style="color:#e1e4e8;">├── Dockerfile</span></span>
<span class="line"><span style="color:#e1e4e8;">└── pgbackrest.conf</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">.</span></span>
<span class="line"><span style="color:#24292e;">├── certs</span></span>
<span class="line"><span style="color:#24292e;">│   ├── private.key</span></span>
<span class="line"><span style="color:#24292e;">│   └── public.crt</span></span>
<span class="line"><span style="color:#24292e;">├── .dockerignore</span></span>
<span class="line"><span style="color:#24292e;">├── compose.yaml</span></span>
<span class="line"><span style="color:#24292e;">├── Dockerfile</span></span>
<span class="line"><span style="color:#24292e;">└── pgbackrest.conf</span></span></code></pre></div><p>命令更新服务</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">docker</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">build</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-t</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo-postgres</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">.</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">docker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">build</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-t</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo-postgres</span><span style="color:#24292E;"> </span><span style="color:#032F62;">.</span></span></code></pre></div><h4 id="备份与恢复操作" tabindex="-1">备份与恢复操作 <a class="header-anchor" href="#备份与恢复操作" aria-label="Permalink to &quot;备份与恢复操作&quot;">​</a></h4><p>现在去查看<code>postgres</code>容器的日志发现报错如下，是因为还没有创建<code>pgbackrest</code>的<code>stanza</code></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">demo-postgres  | 2022-11-24 16:10:56.029 CST [79] LOG:  archive command failed with exit code 103</span></span>
<span class="line"><span style="color:#e1e4e8;">demo-postgres  | 2022-11-24 16:10:56.029 CST [79] DETAIL:  The failed archive command was: pgbackrest --stanza=demo archive-push pg_wal/000000010000000000000001</span></span>
<span class="line"><span style="color:#e1e4e8;">demo-postgres  | ERROR: [103]: unable to find a valid repository:</span></span>
<span class="line"><span style="color:#e1e4e8;">demo-postgres  |        repo1: [FileMissingError] unable to load info file &#39;/test-back/archive/demo/archive.info&#39; or &#39;/test-back/archive/demo/archive.info.copy&#39;:</span></span>
<span class="line"><span style="color:#e1e4e8;">demo-postgres  |        FileMissingError: unable to open missing file &#39;/test-back/archive/demo/archive.info&#39; for read</span></span>
<span class="line"><span style="color:#e1e4e8;">demo-postgres  |        FileMissingError: unable to open missing file &#39;/test-back/archive/demo/archive.info.copy&#39; for read</span></span>
<span class="line"><span style="color:#e1e4e8;">demo-postgres  |        HINT: archive.info cannot be opened but is required to push/get WAL segments.</span></span>
<span class="line"><span style="color:#e1e4e8;">demo-postgres  |        HINT: is archive_command configured correctly in postgresql.conf?</span></span>
<span class="line"><span style="color:#e1e4e8;">demo-postgres  |        HINT: has a stanza-create been performed?</span></span>
<span class="line"><span style="color:#e1e4e8;">demo-postgres  |        HINT: use --no-archive-check to disable archive checks during backup if you have an alternate archiving scheme.</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">demo-postgres  | 2022-11-24 16:10:56.029 CST [79] LOG:  archive command failed with exit code 103</span></span>
<span class="line"><span style="color:#24292e;">demo-postgres  | 2022-11-24 16:10:56.029 CST [79] DETAIL:  The failed archive command was: pgbackrest --stanza=demo archive-push pg_wal/000000010000000000000001</span></span>
<span class="line"><span style="color:#24292e;">demo-postgres  | ERROR: [103]: unable to find a valid repository:</span></span>
<span class="line"><span style="color:#24292e;">demo-postgres  |        repo1: [FileMissingError] unable to load info file &#39;/test-back/archive/demo/archive.info&#39; or &#39;/test-back/archive/demo/archive.info.copy&#39;:</span></span>
<span class="line"><span style="color:#24292e;">demo-postgres  |        FileMissingError: unable to open missing file &#39;/test-back/archive/demo/archive.info&#39; for read</span></span>
<span class="line"><span style="color:#24292e;">demo-postgres  |        FileMissingError: unable to open missing file &#39;/test-back/archive/demo/archive.info.copy&#39; for read</span></span>
<span class="line"><span style="color:#24292e;">demo-postgres  |        HINT: archive.info cannot be opened but is required to push/get WAL segments.</span></span>
<span class="line"><span style="color:#24292e;">demo-postgres  |        HINT: is archive_command configured correctly in postgresql.conf?</span></span>
<span class="line"><span style="color:#24292e;">demo-postgres  |        HINT: has a stanza-create been performed?</span></span>
<span class="line"><span style="color:#24292e;">demo-postgres  |        HINT: use --no-archive-check to disable archive checks during backup if you have an alternate archiving scheme.</span></span></code></pre></div><p>创建<code>stanza</code>之前，需要访问<code>https://127.0.0.1:9002</code>去创建存储桶<code>bucket</code>，名称与<code>pgbackrest.conf</code>文件的<code>repo1-s3-bucket</code>参数保持一致</p><p>执行创建<code>stanza</code>命令, 该命令需要指定使用<code>postgres</code>用户，<code>pgbackrest --stanza=demo --log-level-console=info stanza-create</code>是实际执行的命令，指定创建的<code>stanza</code>为<code>demo</code></p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">docker</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">exec</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-it</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-u</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">postgres</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo-postgres</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pgbackrest</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--stanza=demo</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--log-level-console=info</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">stanza-create</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">2022-11-24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:12:34.689</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">P00</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">stanza-create</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">command</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">begin</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2.41</span><span style="color:#9ECBFF;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--exec-id=96-dada82ab</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--log-level-console=info</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--pg1-path=/var/lib/postgresql/data</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--pg1-user=demo</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--repo1-cipher-pass=</span><span style="color:#F97583;">&lt;</span><span style="color:#79B8FF;">redacted</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--repo1-cipher-type=aes-256-cbc</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--repo1-path=/test-back</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--repo1-s3-bucket=file-bucket</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--repo1-s3-endpoint=minio:9000</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--repo1-s3-key=</span><span style="color:#F97583;">&lt;</span><span style="color:#79B8FF;">redacted</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--repo1-s3-key-secret=</span><span style="color:#F97583;">&lt;</span><span style="color:#79B8FF;">redacted</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--repo1-s3-region=us-east-1</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--repo1-s3-uri-style=path</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--no-repo1-storage-verify-tls</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--repo1-type=s3</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--stanza=demo</span></span>
<span class="line"><span style="color:#B392F0;">2022-11-24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:12:35.293</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">P00</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">stanza-create</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">for</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">stanza</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;demo&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">repo1</span></span>
<span class="line"><span style="color:#B392F0;">2022-11-24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:12:35.320</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">P00</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">stanza-create</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">command</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">end:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">completed</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">successfully</span><span style="color:#E1E4E8;"> (631ms)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">docker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">exec</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-it</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-u</span><span style="color:#24292E;"> </span><span style="color:#032F62;">postgres</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo-postgres</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pgbackrest</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--stanza=demo</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--log-level-console=info</span><span style="color:#24292E;"> </span><span style="color:#032F62;">stanza-create</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">2022-11-24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:12:34.689</span><span style="color:#24292E;"> </span><span style="color:#032F62;">P00</span><span style="color:#24292E;">   </span><span style="color:#032F62;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">stanza-create</span><span style="color:#24292E;"> </span><span style="color:#032F62;">command</span><span style="color:#24292E;"> </span><span style="color:#032F62;">begin</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2.41</span><span style="color:#032F62;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--exec-id=96-dada82ab</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--log-level-console=info</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--pg1-path=/var/lib/postgresql/data</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--pg1-user=demo</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--repo1-cipher-pass=</span><span style="color:#D73A49;">&lt;</span><span style="color:#005CC5;">redacted</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--repo1-cipher-type=aes-256-cbc</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--repo1-path=/test-back</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--repo1-s3-bucket=file-bucket</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--repo1-s3-endpoint=minio:9000</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--repo1-s3-key=</span><span style="color:#D73A49;">&lt;</span><span style="color:#005CC5;">redacted</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--repo1-s3-key-secret=</span><span style="color:#D73A49;">&lt;</span><span style="color:#005CC5;">redacted</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--repo1-s3-region=us-east-1</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--repo1-s3-uri-style=path</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--no-repo1-storage-verify-tls</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--repo1-type=s3</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--stanza=demo</span></span>
<span class="line"><span style="color:#6F42C1;">2022-11-24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:12:35.293</span><span style="color:#24292E;"> </span><span style="color:#032F62;">P00</span><span style="color:#24292E;">   </span><span style="color:#032F62;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">stanza-create</span><span style="color:#24292E;"> </span><span style="color:#032F62;">for</span><span style="color:#24292E;"> </span><span style="color:#032F62;">stanza</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;demo&#39;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">on</span><span style="color:#24292E;"> </span><span style="color:#032F62;">repo1</span></span>
<span class="line"><span style="color:#6F42C1;">2022-11-24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:12:35.320</span><span style="color:#24292E;"> </span><span style="color:#032F62;">P00</span><span style="color:#24292E;">   </span><span style="color:#032F62;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">stanza-create</span><span style="color:#24292E;"> </span><span style="color:#032F62;">command</span><span style="color:#24292E;"> </span><span style="color:#032F62;">end:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">completed</span><span style="color:#24292E;"> </span><span style="color:#032F62;">successfully</span><span style="color:#24292E;"> (631ms)</span></span></code></pre></div><p>执行第一次备份，由于没有上一次全量备份，所以备份会自动转换为全量备份，备份命令是需要有一个定时任务定期去执行的，首次备份由于是全量备份，所以首次执行的时候耗时会比较长，后面的都是增量备份，只会备份有变动的数据，所以会比较快</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">docker</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">exec</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-it</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-u</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">postgres</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo-postgres</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pgbackrest</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--stanza=demo</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--log-level-console=info</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">backup</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">docker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">exec</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-it</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-u</span><span style="color:#24292E;"> </span><span style="color:#032F62;">postgres</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo-postgres</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pgbackrest</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--stanza=demo</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--log-level-console=info</span><span style="color:#24292E;"> </span><span style="color:#032F62;">backup</span></span></code></pre></div><p>现在查看备份文件的信息</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">docker</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">exec</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-it</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-u</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">postgres</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo-postgres</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pgbackrest</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--stanza=demo</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--log-level-console=info</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">info</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">stanza:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">status:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ok</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">cipher:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">aes-256-cbc</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">db</span><span style="color:#E1E4E8;"> (current)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">wal</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">archive</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">min/max</span><span style="color:#E1E4E8;"> (15): 000000010000000000000001/000000010000000000000003</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">full</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">backup:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">20221124</span><span style="color:#9ECBFF;">-161252F</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">timestamp</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">start/stop:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2022</span><span style="color:#9ECBFF;">-11-24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:12:52</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2022</span><span style="color:#9ECBFF;">-11-24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:12:58</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">wal</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">start/stop:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">000000010000000000000003</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">000000010000000000000003</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">database</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">size:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">29.1</span><span style="color:#9ECBFF;">MB,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">database</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">backup</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">size:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">29.1</span><span style="color:#9ECBFF;">MB</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">repo1:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">backup</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">set</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">size:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3.9</span><span style="color:#9ECBFF;">MB,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">backup</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">size:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3.9</span><span style="color:#9ECBFF;">MB</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">docker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">exec</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-it</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-u</span><span style="color:#24292E;"> </span><span style="color:#032F62;">postgres</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo-postgres</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pgbackrest</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--stanza=demo</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--log-level-console=info</span><span style="color:#24292E;"> </span><span style="color:#032F62;">info</span><span style="color:#24292E;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">stanza:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">status:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ok</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">cipher:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">aes-256-cbc</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">db</span><span style="color:#24292E;"> (current)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">wal</span><span style="color:#24292E;"> </span><span style="color:#032F62;">archive</span><span style="color:#24292E;"> </span><span style="color:#032F62;">min/max</span><span style="color:#24292E;"> (15): 000000010000000000000001/000000010000000000000003</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">full</span><span style="color:#24292E;"> </span><span style="color:#032F62;">backup:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">20221124</span><span style="color:#032F62;">-161252F</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">timestamp</span><span style="color:#24292E;"> </span><span style="color:#032F62;">start/stop:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2022</span><span style="color:#032F62;">-11-24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:12:52</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2022</span><span style="color:#032F62;">-11-24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:12:58</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">wal</span><span style="color:#24292E;"> </span><span style="color:#032F62;">start/stop:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">000000010000000000000003</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">000000010000000000000003</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">database</span><span style="color:#24292E;"> </span><span style="color:#032F62;">size:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">29.1</span><span style="color:#032F62;">MB,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">database</span><span style="color:#24292E;"> </span><span style="color:#032F62;">backup</span><span style="color:#24292E;"> </span><span style="color:#032F62;">size:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">29.1</span><span style="color:#032F62;">MB</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">repo1:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">backup</span><span style="color:#24292E;"> </span><span style="color:#032F62;">set</span><span style="color:#24292E;"> </span><span style="color:#032F62;">size:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3.9</span><span style="color:#032F62;">MB,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">backup</span><span style="color:#24292E;"> </span><span style="color:#032F62;">size:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3.9</span><span style="color:#032F62;">MB</span></span></code></pre></div><p>现在去对象存储的页面发现已经有归档文件和备份文件</p><p>现在去数据库执行数据表创建命令，并且写入一些数据</p><p>目前数据表的输入如下</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> users u ;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">	user0	</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">	false	</span><span style="color:#79B8FF;">2022</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">11</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">14</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">18</span></span>
<span class="line"><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">	user2	</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">	false	</span><span style="color:#79B8FF;">2022</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">11</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">14</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">18</span></span>
<span class="line"><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">	user2	</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">	false	</span><span style="color:#79B8FF;">2022</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">11</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">14</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">18</span></span>
<span class="line"><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">	user16	</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">	false	</span><span style="color:#79B8FF;">2022</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">11</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">14</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">18</span></span>
<span class="line"><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;">	user1	</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">	false	</span><span style="color:#79B8FF;">2022</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">11</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">14</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">18</span></span>
<span class="line"><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;">	user2	</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">	false	</span><span style="color:#79B8FF;">2022</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">11</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">14</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">18</span></span>
<span class="line"><span style="color:#79B8FF;">7</span><span style="color:#E1E4E8;">	user3	</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">	false	</span><span style="color:#79B8FF;">2022</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">11</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">14</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">18</span></span>
<span class="line"><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">	user16	</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">	false	</span><span style="color:#79B8FF;">2022</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">11</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">14</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">18</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">select</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> users u ;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;">1</span><span style="color:#24292E;">	user0	</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">	false	</span><span style="color:#005CC5;">2022</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">11</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">14</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">18</span></span>
<span class="line"><span style="color:#005CC5;">2</span><span style="color:#24292E;">	user2	</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">	false	</span><span style="color:#005CC5;">2022</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">11</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">14</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">18</span></span>
<span class="line"><span style="color:#005CC5;">3</span><span style="color:#24292E;">	user2	</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">	false	</span><span style="color:#005CC5;">2022</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">11</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">14</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">18</span></span>
<span class="line"><span style="color:#005CC5;">4</span><span style="color:#24292E;">	user16	</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">	false	</span><span style="color:#005CC5;">2022</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">11</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">14</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">18</span></span>
<span class="line"><span style="color:#005CC5;">5</span><span style="color:#24292E;">	user1	</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">	false	</span><span style="color:#005CC5;">2022</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">11</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">14</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">18</span></span>
<span class="line"><span style="color:#005CC5;">6</span><span style="color:#24292E;">	user2	</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">	false	</span><span style="color:#005CC5;">2022</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">11</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">14</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">18</span></span>
<span class="line"><span style="color:#005CC5;">7</span><span style="color:#24292E;">	user3	</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">	false	</span><span style="color:#005CC5;">2022</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">11</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">14</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">18</span></span>
<span class="line"><span style="color:#005CC5;">8</span><span style="color:#24292E;">	user16	</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">	false	</span><span style="color:#005CC5;">2022</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">11</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">14</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">18</span></span></code></pre></div><p>等待<code>30秒</code>之后，再次执行备份命令，等待时间和<code>archive_timeout</code>参数有关，目的是确保上次数据表创建，写入的事务已经归档产生了新的完整<code>wal</code>段，该段可以被归档备份</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">docker</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">exec</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-it</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-u</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">postgres</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo-postgres</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pgbackrest</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--stanza=demo</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--log-level-console=info</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">backup</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">docker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">exec</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-it</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-u</span><span style="color:#24292E;"> </span><span style="color:#032F62;">postgres</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo-postgres</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pgbackrest</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--stanza=demo</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--log-level-console=info</span><span style="color:#24292E;"> </span><span style="color:#032F62;">backup</span></span></code></pre></div><p>现在再次往<code>users</code>表写入一些数据，把这些数据当做脏数据</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> users u ;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">	user0	</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">	false	</span><span style="color:#79B8FF;">2022</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">11</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">14</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">18</span></span>
<span class="line"><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">	user2	</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">	false	</span><span style="color:#79B8FF;">2022</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">11</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">14</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">18</span></span>
<span class="line"><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">	user2	</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">	false	</span><span style="color:#79B8FF;">2022</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">11</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">14</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">18</span></span>
<span class="line"><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">	user16	</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">	false	</span><span style="color:#79B8FF;">2022</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">11</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">14</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">18</span></span>
<span class="line"><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;">	user1	</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">	false	</span><span style="color:#79B8FF;">2022</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">11</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">14</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">18</span></span>
<span class="line"><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;">	user2	</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">	false	</span><span style="color:#79B8FF;">2022</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">11</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">14</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">18</span></span>
<span class="line"><span style="color:#79B8FF;">7</span><span style="color:#E1E4E8;">	user3	</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">	false	</span><span style="color:#79B8FF;">2022</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">11</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">14</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">18</span></span>
<span class="line"><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">	user16	</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">	false	</span><span style="color:#79B8FF;">2022</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">11</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">14</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">18</span></span>
<span class="line"><span style="color:#79B8FF;">9</span><span style="color:#E1E4E8;">	user0	</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">	false	</span><span style="color:#79B8FF;">2022</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">11</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">19</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">35</span></span>
<span class="line"><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">	user0	</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">	false	</span><span style="color:#79B8FF;">2022</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">11</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">19</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">35</span></span>
<span class="line"><span style="color:#79B8FF;">11</span><span style="color:#E1E4E8;">	user5	</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">	false	</span><span style="color:#79B8FF;">2022</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">11</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">19</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">35</span></span>
<span class="line"><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;">	user2	</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">	false	</span><span style="color:#79B8FF;">2022</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">11</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">19</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">35</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">select</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> users u ;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;">1</span><span style="color:#24292E;">	user0	</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">	false	</span><span style="color:#005CC5;">2022</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">11</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">14</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">18</span></span>
<span class="line"><span style="color:#005CC5;">2</span><span style="color:#24292E;">	user2	</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">	false	</span><span style="color:#005CC5;">2022</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">11</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">14</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">18</span></span>
<span class="line"><span style="color:#005CC5;">3</span><span style="color:#24292E;">	user2	</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">	false	</span><span style="color:#005CC5;">2022</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">11</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">14</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">18</span></span>
<span class="line"><span style="color:#005CC5;">4</span><span style="color:#24292E;">	user16	</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">	false	</span><span style="color:#005CC5;">2022</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">11</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">14</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">18</span></span>
<span class="line"><span style="color:#005CC5;">5</span><span style="color:#24292E;">	user1	</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">	false	</span><span style="color:#005CC5;">2022</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">11</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">14</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">18</span></span>
<span class="line"><span style="color:#005CC5;">6</span><span style="color:#24292E;">	user2	</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">	false	</span><span style="color:#005CC5;">2022</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">11</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">14</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">18</span></span>
<span class="line"><span style="color:#005CC5;">7</span><span style="color:#24292E;">	user3	</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">	false	</span><span style="color:#005CC5;">2022</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">11</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">14</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">18</span></span>
<span class="line"><span style="color:#005CC5;">8</span><span style="color:#24292E;">	user16	</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">	false	</span><span style="color:#005CC5;">2022</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">11</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">14</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">18</span></span>
<span class="line"><span style="color:#005CC5;">9</span><span style="color:#24292E;">	user0	</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">	false	</span><span style="color:#005CC5;">2022</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">11</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">19</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">35</span></span>
<span class="line"><span style="color:#005CC5;">10</span><span style="color:#24292E;">	user0	</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">	false	</span><span style="color:#005CC5;">2022</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">11</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">19</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">35</span></span>
<span class="line"><span style="color:#005CC5;">11</span><span style="color:#24292E;">	user5	</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">	false	</span><span style="color:#005CC5;">2022</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">11</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">19</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">35</span></span>
<span class="line"><span style="color:#005CC5;">12</span><span style="color:#24292E;">	user2	</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">	false	</span><span style="color:#005CC5;">2022</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">11</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">19</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">35</span></span></code></pre></div><p>现在开始执行数据按照时间点回滚，现在需要回滚到<code>2022-11-24 16:14:20</code>，即脏数据产生之前的一个时间点</p><p>现在停止服务</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">docker</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">compose</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">down</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">docker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">compose</span><span style="color:#24292E;"> </span><span style="color:#032F62;">down</span></span></code></pre></div><p>调整<code>compose.yaml</code>文件如下</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#9ECBFF;">// --snip--</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demo-postgres</span></span>
<span class="line"><span style="color:#6A737D;">#   command: postgres -c archive_mode=on -c archive_command=&#39;pgbackrest --stanza=demo archive-push %p&#39; -c archive_timeout=30</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">command</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#9ECBFF;">/bin/sh</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#9ECBFF;">-c</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#F97583;">|</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF;">           rm -f /var/lib/postgresql/data/postmaster.pid &amp;&amp;</span></span>
<span class="line"><span style="color:#9ECBFF;">           echo &quot;delete ok&quot; &amp;&amp;</span></span>
<span class="line"><span style="color:#9ECBFF;">           pgbackrest --stanza=demo --delta --type=time &quot;--target=2022-11-24 16:14:20+08&quot; --target-action=promote restore</span></span>
<span class="line"><span style="color:#9ECBFF;">// --snip--</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#032F62;">// --snip--</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demo-postgres</span></span>
<span class="line"><span style="color:#6A737D;">#   command: postgres -c archive_mode=on -c archive_command=&#39;pgbackrest --stanza=demo archive-push %p&#39; -c archive_timeout=30</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">command</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#032F62;">/bin/sh</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#032F62;">-c</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#D73A49;">|</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">           rm -f /var/lib/postgresql/data/postmaster.pid &amp;&amp;</span></span>
<span class="line"><span style="color:#032F62;">           echo &quot;delete ok&quot; &amp;&amp;</span></span>
<span class="line"><span style="color:#032F62;">           pgbackrest --stanza=demo --delta --type=time &quot;--target=2022-11-24 16:14:20+08&quot; --target-action=promote restore</span></span>
<span class="line"><span style="color:#032F62;">// --snip--</span></span></code></pre></div><ul><li>由于数据恢复的时候需要关闭数据库，<code>postgres</code>又是运行在容器内部的，所以需要调整<code>compose.yaml</code>文件的<code>postgres</code>服务的启动<code>command</code></li><li>执行恢复的时候<code>pgbackrest</code>会检测数据库是否正在运行，有一个判断条件是检测一个<code>pid</code>文件是否存在，所以在执行恢复之前执行删除<code>/var/lib/postgresql/data/postmaster.pid</code></li><li>执行<code>pgbackrest</code>指定恢复类型是按照时间点恢复，时间点参数是上文中的<code>2022-11-24 16:14:20+08</code>，需要带上时区信息，确保时间是绝对的</li><li><code>target-action</code>指定在达到恢复目标时服务器应该立刻采取的动作，默认动作是<code>pause</code><ul><li><code>pause</code>表示恢复将会被暂停</li><li><code>promote</code>表示恢复处理将会结束并且服务器将开始接受连接</li><li><code>shutdown</code>将在达到恢复目标之后停止服务器</li></ul></li></ul><p>修改完成之后，开始启动服务</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">docker</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">compose</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">up</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-d</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">docker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">compose</span><span style="color:#24292E;"> </span><span style="color:#032F62;">up</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span></span></code></pre></div><p>查看日志如下，<code>demo-postgres exited with code 0</code>表示数据恢复成功运行，容器正常退出</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">docker</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">compose</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">logs</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">Attaching</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo-minio,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo-postgres</span></span>
<span class="line"><span style="color:#B392F0;">demo-postgres</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">delete</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ok</span></span>
<span class="line"><span style="color:#B392F0;">//</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--snip--</span></span>
<span class="line"><span style="color:#B392F0;">demo-postgres</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">exited</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">with</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">code</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#B392F0;">demo-postgres</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">exited</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">with</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">code</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">docker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">compose</span><span style="color:#24292E;"> </span><span style="color:#032F62;">logs</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">Attaching</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo-minio,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo-postgres</span></span>
<span class="line"><span style="color:#6F42C1;">demo-postgres</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">delete</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ok</span></span>
<span class="line"><span style="color:#6F42C1;">//</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--snip--</span></span>
<span class="line"><span style="color:#6F42C1;">demo-postgres</span><span style="color:#24292E;"> </span><span style="color:#032F62;">exited</span><span style="color:#24292E;"> </span><span style="color:#032F62;">with</span><span style="color:#24292E;"> </span><span style="color:#032F62;">code</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#6F42C1;">demo-postgres</span><span style="color:#24292E;"> </span><span style="color:#032F62;">exited</span><span style="color:#24292E;"> </span><span style="color:#032F62;">with</span><span style="color:#24292E;"> </span><span style="color:#032F62;">code</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span></code></pre></div><p>现在停止服务</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">docker</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">compose</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">down</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">docker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">compose</span><span style="color:#24292E;"> </span><span style="color:#032F62;">down</span></span></code></pre></div><p>把<code>compose.yaml</code>文件当中<code>postgres</code>的启动命令修改为原来的正常命令</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">command: postgres -c archive_mode=on -c archive_command=&#39;pgbackrest --stanza=demo archive-push %p&#39; -c archive_timeout=30</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">command: postgres -c archive_mode=on -c archive_command=&#39;pgbackrest --stanza=demo archive-push %p&#39; -c archive_timeout=30</span></span></code></pre></div><p>最后启动容器并且查看日志如下，输出中有最后一句<code>last completed transaction was at log time last completed transaction was at log time 2022-11-24 16:14:18.533467+08</code>，表示恢复在<code>2022-11-24 16:14:18.533467+08</code>的最后一个事务停止了，虽然我们指定的是数据库恢复到<code>--target=2022-11-24 16:14:20+08</code>，但是在这个表示的是截止到我们指定时间点的以前所有事务都会被执行重放恢复</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">docker</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">compose</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">up</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-d</span></span>
<span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">docker</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">compose</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">logs</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">//</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--snip--</span></span>
<span class="line"><span style="color:#B392F0;">demo-postgres</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">2022-11-24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:39:07.347</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">CST</span><span style="color:#E1E4E8;"> [28] LOG:  database system was interrupted; </span><span style="color:#B392F0;">last</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">known</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">up</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">at</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2022</span><span style="color:#9ECBFF;">-11-24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:12:52</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">CST</span></span>
<span class="line"><span style="color:#B392F0;">demo-postgres</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">2022-11-24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:39:07.411</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">CST</span><span style="color:#E1E4E8;"> [28] LOG:  starting point-in-time recovery to 2022-11-24 16:14:20+08</span></span>
<span class="line"><span style="color:#B392F0;">demo-postgres</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">2022-11-24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:39:07.452</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">CST</span><span style="color:#E1E4E8;"> [28] LOG:  restored log file </span><span style="color:#9ECBFF;">&quot;000000010000000000000003&quot;</span><span style="color:#E1E4E8;"> from archive</span></span>
<span class="line"><span style="color:#B392F0;">demo-postgres</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">2022-11-24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:39:07.466</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">CST</span><span style="color:#E1E4E8;"> [28] LOG:  redo starts at 0/3000028</span></span>
<span class="line"><span style="color:#B392F0;">demo-postgres</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">2022-11-24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:39:07.509</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">CST</span><span style="color:#E1E4E8;"> [28] LOG:  restored log file </span><span style="color:#9ECBFF;">&quot;000000010000000000000004&quot;</span><span style="color:#E1E4E8;"> from archive</span></span>
<span class="line"><span style="color:#B392F0;">demo-postgres</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">2022-11-24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:39:07.523</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">CST</span><span style="color:#E1E4E8;"> [28] LOG:  consistent recovery state reached at 0/3000138</span></span>
<span class="line"><span style="color:#B392F0;">demo-postgres</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">2022-11-24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:39:07.523</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">CST</span><span style="color:#E1E4E8;"> [1] LOG:  database system is ready to accept read-only connections</span></span>
<span class="line"><span style="color:#B392F0;">demo-postgres</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">2022-11-24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:39:07.562</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">CST</span><span style="color:#E1E4E8;"> [28] LOG:  restored log file </span><span style="color:#9ECBFF;">&quot;000000010000000000000005&quot;</span><span style="color:#E1E4E8;"> from archive</span></span>
<span class="line"><span style="color:#B392F0;">demo-postgres</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">2022-11-24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:39:07.613</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">CST</span><span style="color:#E1E4E8;"> [28] LOG:  restored log file </span><span style="color:#9ECBFF;">&quot;000000010000000000000006&quot;</span><span style="color:#E1E4E8;"> from archive</span></span>
<span class="line"><span style="color:#B392F0;">demo-postgres</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">2022-11-24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:39:07.744</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">CST</span><span style="color:#E1E4E8;"> [28] LOG:  restored log file </span><span style="color:#9ECBFF;">&quot;000000010000000000000007&quot;</span><span style="color:#E1E4E8;"> from archive</span></span>
<span class="line"><span style="color:#B392F0;">demo-postgres</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">2022-11-24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:39:07.963</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">CST</span><span style="color:#E1E4E8;"> [28] LOG:  restored log file </span><span style="color:#9ECBFF;">&quot;000000010000000000000008&quot;</span><span style="color:#E1E4E8;"> from archive</span></span>
<span class="line"><span style="color:#B392F0;">demo-postgres</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">2022-11-24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:39:08.000</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">CST</span><span style="color:#E1E4E8;"> [28] LOG:  recovery stopping before commit of transaction 740, </span><span style="color:#F97583;">time</span><span style="color:#E1E4E8;"> 2022-11-24 16:19:35.987987+08</span></span>
<span class="line"><span style="color:#B392F0;">demo-postgres</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">2022-11-24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:39:08.000</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">CST</span><span style="color:#E1E4E8;"> [28] LOG:  redo </span><span style="color:#F97583;">done</span><span style="color:#E1E4E8;"> at 0/7000618 system usage: CPU: user: 0.00 s, system: 0.01 s, elapsed: 0.53 s</span></span>
<span class="line"><span style="color:#B392F0;">demo-postgres</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">2022-11-24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:39:08.000</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">CST</span><span style="color:#E1E4E8;"> [28] LOG:  last completed transaction was at log </span><span style="color:#F97583;">time</span><span style="color:#E1E4E8;"> 2022-11-24 16:14:18.533467+08</span></span>
<span class="line"><span style="color:#B392F0;">demo-postgres</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">2022-11-24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:39:08.069</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">CST</span><span style="color:#E1E4E8;"> [28] LOG:  restored log file </span><span style="color:#9ECBFF;">&quot;000000010000000000000007&quot;</span><span style="color:#E1E4E8;"> from archive</span></span>
<span class="line"><span style="color:#B392F0;">demo-postgres</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">2022-11-24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:39:08.099</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">CST</span><span style="color:#E1E4E8;"> [28] LOG:  selected new timeline ID: 2</span></span>
<span class="line"><span style="color:#B392F0;">demo-postgres</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">2022-11-24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:39:08.143</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">CST</span><span style="color:#E1E4E8;"> [28] LOG:  archive recovery complete</span></span>
<span class="line"><span style="color:#B392F0;">demo-postgres</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">2022-11-24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:39:08.144</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">CST</span><span style="color:#E1E4E8;"> [26] LOG:  checkpoint starting: end-of-recovery immediate wait</span></span>
<span class="line"><span style="color:#B392F0;">demo-postgres</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">2022-11-24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:39:08.162</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">CST</span><span style="color:#E1E4E8;"> [26] LOG:  checkpoint complete: wrote 50 buffers (</span><span style="color:#B392F0;">0.3%</span><span style="color:#E1E4E8;">); </span><span style="color:#B392F0;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">WAL</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">file</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">s</span><span style="color:#E1E4E8;">) </span><span style="color:#9ECBFF;">added,</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">removed,</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">recycled</span><span style="color:#E1E4E8;">; write</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0.004</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">s,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">sync=</span><span style="color:#79B8FF;">0.005</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">s,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">total=</span><span style="color:#79B8FF;">0.019</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">; </span><span style="color:#B392F0;">sync</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">files=</span><span style="color:#79B8FF;">39</span><span style="color:#9ECBFF;">,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">longest=</span><span style="color:#79B8FF;">0.002</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">s,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">average=</span><span style="color:#79B8FF;">0.001</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">; distance</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">65537</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">kB,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">estimate=</span><span style="color:#79B8FF;">65537</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kB</span></span>
<span class="line"><span style="color:#B392F0;">demo-postgres</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">2022-11-24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:39:08.169</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">CST</span><span style="color:#E1E4E8;"> [1] LOG:  database system is ready to accept connections</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">docker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">compose</span><span style="color:#24292E;"> </span><span style="color:#032F62;">up</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span></span>
<span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">docker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">compose</span><span style="color:#24292E;"> </span><span style="color:#032F62;">logs</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">//</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--snip--</span></span>
<span class="line"><span style="color:#6F42C1;">demo-postgres</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">2022-11-24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:39:07.347</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CST</span><span style="color:#24292E;"> [28] LOG:  database system was interrupted; </span><span style="color:#6F42C1;">last</span><span style="color:#24292E;"> </span><span style="color:#032F62;">known</span><span style="color:#24292E;"> </span><span style="color:#032F62;">up</span><span style="color:#24292E;"> </span><span style="color:#032F62;">at</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2022</span><span style="color:#032F62;">-11-24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:12:52</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CST</span></span>
<span class="line"><span style="color:#6F42C1;">demo-postgres</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">2022-11-24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:39:07.411</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CST</span><span style="color:#24292E;"> [28] LOG:  starting point-in-time recovery to 2022-11-24 16:14:20+08</span></span>
<span class="line"><span style="color:#6F42C1;">demo-postgres</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">2022-11-24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:39:07.452</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CST</span><span style="color:#24292E;"> [28] LOG:  restored log file </span><span style="color:#032F62;">&quot;000000010000000000000003&quot;</span><span style="color:#24292E;"> from archive</span></span>
<span class="line"><span style="color:#6F42C1;">demo-postgres</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">2022-11-24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:39:07.466</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CST</span><span style="color:#24292E;"> [28] LOG:  redo starts at 0/3000028</span></span>
<span class="line"><span style="color:#6F42C1;">demo-postgres</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">2022-11-24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:39:07.509</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CST</span><span style="color:#24292E;"> [28] LOG:  restored log file </span><span style="color:#032F62;">&quot;000000010000000000000004&quot;</span><span style="color:#24292E;"> from archive</span></span>
<span class="line"><span style="color:#6F42C1;">demo-postgres</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">2022-11-24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:39:07.523</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CST</span><span style="color:#24292E;"> [28] LOG:  consistent recovery state reached at 0/3000138</span></span>
<span class="line"><span style="color:#6F42C1;">demo-postgres</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">2022-11-24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:39:07.523</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CST</span><span style="color:#24292E;"> [1] LOG:  database system is ready to accept read-only connections</span></span>
<span class="line"><span style="color:#6F42C1;">demo-postgres</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">2022-11-24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:39:07.562</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CST</span><span style="color:#24292E;"> [28] LOG:  restored log file </span><span style="color:#032F62;">&quot;000000010000000000000005&quot;</span><span style="color:#24292E;"> from archive</span></span>
<span class="line"><span style="color:#6F42C1;">demo-postgres</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">2022-11-24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:39:07.613</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CST</span><span style="color:#24292E;"> [28] LOG:  restored log file </span><span style="color:#032F62;">&quot;000000010000000000000006&quot;</span><span style="color:#24292E;"> from archive</span></span>
<span class="line"><span style="color:#6F42C1;">demo-postgres</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">2022-11-24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:39:07.744</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CST</span><span style="color:#24292E;"> [28] LOG:  restored log file </span><span style="color:#032F62;">&quot;000000010000000000000007&quot;</span><span style="color:#24292E;"> from archive</span></span>
<span class="line"><span style="color:#6F42C1;">demo-postgres</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">2022-11-24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:39:07.963</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CST</span><span style="color:#24292E;"> [28] LOG:  restored log file </span><span style="color:#032F62;">&quot;000000010000000000000008&quot;</span><span style="color:#24292E;"> from archive</span></span>
<span class="line"><span style="color:#6F42C1;">demo-postgres</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">2022-11-24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:39:08.000</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CST</span><span style="color:#24292E;"> [28] LOG:  recovery stopping before commit of transaction 740, </span><span style="color:#D73A49;">time</span><span style="color:#24292E;"> 2022-11-24 16:19:35.987987+08</span></span>
<span class="line"><span style="color:#6F42C1;">demo-postgres</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">2022-11-24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:39:08.000</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CST</span><span style="color:#24292E;"> [28] LOG:  redo </span><span style="color:#D73A49;">done</span><span style="color:#24292E;"> at 0/7000618 system usage: CPU: user: 0.00 s, system: 0.01 s, elapsed: 0.53 s</span></span>
<span class="line"><span style="color:#6F42C1;">demo-postgres</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">2022-11-24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:39:08.000</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CST</span><span style="color:#24292E;"> [28] LOG:  last completed transaction was at log </span><span style="color:#D73A49;">time</span><span style="color:#24292E;"> 2022-11-24 16:14:18.533467+08</span></span>
<span class="line"><span style="color:#6F42C1;">demo-postgres</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">2022-11-24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:39:08.069</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CST</span><span style="color:#24292E;"> [28] LOG:  restored log file </span><span style="color:#032F62;">&quot;000000010000000000000007&quot;</span><span style="color:#24292E;"> from archive</span></span>
<span class="line"><span style="color:#6F42C1;">demo-postgres</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">2022-11-24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:39:08.099</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CST</span><span style="color:#24292E;"> [28] LOG:  selected new timeline ID: 2</span></span>
<span class="line"><span style="color:#6F42C1;">demo-postgres</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">2022-11-24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:39:08.143</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CST</span><span style="color:#24292E;"> [28] LOG:  archive recovery complete</span></span>
<span class="line"><span style="color:#6F42C1;">demo-postgres</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">2022-11-24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:39:08.144</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CST</span><span style="color:#24292E;"> [26] LOG:  checkpoint starting: end-of-recovery immediate wait</span></span>
<span class="line"><span style="color:#6F42C1;">demo-postgres</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">2022-11-24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:39:08.162</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CST</span><span style="color:#24292E;"> [26] LOG:  checkpoint complete: wrote 50 buffers (</span><span style="color:#6F42C1;">0.3%</span><span style="color:#24292E;">); </span><span style="color:#6F42C1;">0</span><span style="color:#24292E;"> </span><span style="color:#032F62;">WAL</span><span style="color:#24292E;"> </span><span style="color:#032F62;">file</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">s</span><span style="color:#24292E;">) </span><span style="color:#032F62;">added,</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#032F62;">removed,</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#24292E;"> </span><span style="color:#032F62;">recycled</span><span style="color:#24292E;">; write</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0.004</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">s,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">sync=</span><span style="color:#005CC5;">0.005</span><span style="color:#24292E;"> </span><span style="color:#032F62;">s,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">total=</span><span style="color:#005CC5;">0.019</span><span style="color:#24292E;"> </span><span style="color:#032F62;">s</span><span style="color:#24292E;">; </span><span style="color:#6F42C1;">sync</span><span style="color:#24292E;"> </span><span style="color:#032F62;">files=</span><span style="color:#005CC5;">39</span><span style="color:#032F62;">,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">longest=</span><span style="color:#005CC5;">0.002</span><span style="color:#24292E;"> </span><span style="color:#032F62;">s,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">average=</span><span style="color:#005CC5;">0.001</span><span style="color:#24292E;"> </span><span style="color:#032F62;">s</span><span style="color:#24292E;">; distance</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">65537</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">kB,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">estimate=</span><span style="color:#005CC5;">65537</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kB</span></span>
<span class="line"><span style="color:#6F42C1;">demo-postgres</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">2022-11-24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:39:08.169</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CST</span><span style="color:#24292E;"> [1] LOG:  database system is ready to accept connections</span></span></code></pre></div><p>现在去查看数据库，发现我们后面的增加的那些脏数据没有了</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> users u ;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">	user0	</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">	false	</span><span style="color:#79B8FF;">2022</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">11</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">14</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">18</span></span>
<span class="line"><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">	user2	</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">	false	</span><span style="color:#79B8FF;">2022</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">11</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">14</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">18</span></span>
<span class="line"><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">	user2	</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">	false	</span><span style="color:#79B8FF;">2022</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">11</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">14</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">18</span></span>
<span class="line"><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">	user16	</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">	false	</span><span style="color:#79B8FF;">2022</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">11</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">14</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">18</span></span>
<span class="line"><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;">	user1	</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">	false	</span><span style="color:#79B8FF;">2022</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">11</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">14</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">18</span></span>
<span class="line"><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;">	user2	</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">	false	</span><span style="color:#79B8FF;">2022</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">11</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">14</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">18</span></span>
<span class="line"><span style="color:#79B8FF;">7</span><span style="color:#E1E4E8;">	user3	</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">	false	</span><span style="color:#79B8FF;">2022</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">11</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">14</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">18</span></span>
<span class="line"><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">	user16	</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">	false	</span><span style="color:#79B8FF;">2022</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">11</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">14</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">18</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">select</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> users u ;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;">1</span><span style="color:#24292E;">	user0	</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">	false	</span><span style="color:#005CC5;">2022</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">11</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">14</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">18</span></span>
<span class="line"><span style="color:#005CC5;">2</span><span style="color:#24292E;">	user2	</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">	false	</span><span style="color:#005CC5;">2022</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">11</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">14</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">18</span></span>
<span class="line"><span style="color:#005CC5;">3</span><span style="color:#24292E;">	user2	</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">	false	</span><span style="color:#005CC5;">2022</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">11</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">14</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">18</span></span>
<span class="line"><span style="color:#005CC5;">4</span><span style="color:#24292E;">	user16	</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">	false	</span><span style="color:#005CC5;">2022</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">11</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">14</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">18</span></span>
<span class="line"><span style="color:#005CC5;">5</span><span style="color:#24292E;">	user1	</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">	false	</span><span style="color:#005CC5;">2022</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">11</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">14</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">18</span></span>
<span class="line"><span style="color:#005CC5;">6</span><span style="color:#24292E;">	user2	</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">	false	</span><span style="color:#005CC5;">2022</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">11</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">14</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">18</span></span>
<span class="line"><span style="color:#005CC5;">7</span><span style="color:#24292E;">	user3	</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">	false	</span><span style="color:#005CC5;">2022</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">11</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">14</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">18</span></span>
<span class="line"><span style="color:#005CC5;">8</span><span style="color:#24292E;">	user16	</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">	false	</span><span style="color:#005CC5;">2022</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">11</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">14</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">18</span></span></code></pre></div><p>如果不需要指定按照时间点恢复，则可以指定全量恢复，即备份了多少归档<code>wal</code>，恢复到多少，<code>compose.yaml</code>的<code>postgres</code>服务的启动<code>command</code>改为如下即可，主要变动是<code>--type</code>的参数改成<code>immediate</code></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">// --snip--</span></span>
<span class="line"><span style="color:#e1e4e8;">   image: demo-postgres</span></span>
<span class="line"><span style="color:#e1e4e8;">#   command: postgres -c archive_mode=on -c archive_command=&#39;pgbackrest --stanza=demo archive-push %p&#39; -c archive_timeout=30</span></span>
<span class="line"><span style="color:#e1e4e8;">    command:</span></span>
<span class="line"><span style="color:#e1e4e8;">      - /bin/sh</span></span>
<span class="line"><span style="color:#e1e4e8;">      - -c</span></span>
<span class="line"><span style="color:#e1e4e8;">      - |</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">           rm -f /var/lib/postgresql/data/postmaster.pid &amp;&amp;</span></span>
<span class="line"><span style="color:#e1e4e8;">           echo &quot;delete ok&quot; &amp;&amp;</span></span>
<span class="line"><span style="color:#e1e4e8;">           pgbackrest --stanza=demo --delta --type=immediate --target-action=promote restore</span></span>
<span class="line"><span style="color:#e1e4e8;">// --snip--</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">// --snip--</span></span>
<span class="line"><span style="color:#24292e;">   image: demo-postgres</span></span>
<span class="line"><span style="color:#24292e;">#   command: postgres -c archive_mode=on -c archive_command=&#39;pgbackrest --stanza=demo archive-push %p&#39; -c archive_timeout=30</span></span>
<span class="line"><span style="color:#24292e;">    command:</span></span>
<span class="line"><span style="color:#24292e;">      - /bin/sh</span></span>
<span class="line"><span style="color:#24292e;">      - -c</span></span>
<span class="line"><span style="color:#24292e;">      - |</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">           rm -f /var/lib/postgresql/data/postmaster.pid &amp;&amp;</span></span>
<span class="line"><span style="color:#24292e;">           echo &quot;delete ok&quot; &amp;&amp;</span></span>
<span class="line"><span style="color:#24292e;">           pgbackrest --stanza=demo --delta --type=immediate --target-action=promote restore</span></span>
<span class="line"><span style="color:#24292e;">// --snip--</span></span></code></pre></div><h2 id="小结" tabindex="-1">小结 <a class="header-anchor" href="#小结" aria-label="Permalink to &quot;小结&quot;">​</a></h2><p>总体来说，增量备份和按照时间点恢复数据的操作是比较繁琐的，也踩了很多的坑，希望有一天<code>postgres</code>可以官方支持一个配置选项，可以自己增量备份与按照时间点恢复，目前发现比较靠谱的第三方都已经写成一个项目的备份恢复，大概只有<code>pgbackrest</code>,<code>wal-g</code>,<code>barman</code>比较靠谱，后面有兴趣可以去尝试一下。</p><h2 id="阅读参考" tabindex="-1">阅读参考 <a class="header-anchor" href="#阅读参考" aria-label="Permalink to &quot;阅读参考&quot;">​</a></h2><p><a href="http://www.postgres.cn/docs/14/backup.html" target="_blank" rel="noreferrer"><code>postgresql</code>中文文档</a></p><p><a href="https://pgbackrest.org/user-guide.html" target="_blank" rel="noreferrer"><code>pgbackrest</code>文档</a></p><p><a href="https://github.com/FiloSottile/mkcert" target="_blank" rel="noreferrer"><code>mkcert</code>官方项目</a></p><p><a href="http://docs.aws.amazon.com/AmazonS3/latest/dev/VirtualHosting.html" target="_blank" rel="noreferrer"><code>Amazon S3: Virtual Hosting of Buckets</code></a></p>`,148),e=[l];function c(t,r,y,E,i,d){return a(),n("div",null,e)}const g=s(o,[["render",c]]);export{C as __pageData,g as default};
