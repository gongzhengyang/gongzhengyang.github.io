import{_ as s,o as a,c as n,Q as o}from"./chunks/framework.36bc40e2.js";const u=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[],"relativePath":"published/system/freebsd配置服务开机自启动.md","filePath":"published/system/freebsd配置服务开机自启动.md","lastUpdated":1693296118000}'),e={name:"published/system/freebsd配置服务开机自启动.md"},p=o(`<p><code>freebsd</code>由于没使用<code>systemd</code>，所以会采用配置<code>/etc/rc.d/</code>文件的方式配置服务启动</p><h2 id="服务模拟脚本" tabindex="-1">服务模拟脚本 <a class="header-anchor" href="#服务模拟脚本" aria-label="Permalink to &quot;服务模拟脚本&quot;">​</a></h2><p><strong>开机自启动脚本执行的时候不能阻塞，<code>freebsd</code>服务启动的时候是串行执行的，一条命令卡住，所有后续服务不能执行</strong></p><p>新建脚本<code>/root/test-boot.sh</code>，注意最后面要加上<code>&amp;</code>以免阻塞</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#!/bin/sh</span></span>
<span class="line"><span style="color:#B392F0;">sh</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-c</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;while true;do date &gt;&gt; /root/test-boot.log; sleep 1; done&quot;</span><span style="color:#E1E4E8;"> &amp;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#!/bin/sh</span></span>
<span class="line"><span style="color:#6F42C1;">sh</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-c</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;while true;do date &gt;&gt; /root/test-boot.log; sleep 1; done&quot;</span><span style="color:#24292E;"> &amp;</span></span></code></pre></div><p>下面执行脚本</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">chmod</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">a+x</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">test-boot.sh</span></span>
<span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">./test-boot.sh</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">chmod</span><span style="color:#24292E;"> </span><span style="color:#032F62;">a+x</span><span style="color:#24292E;"> </span><span style="color:#032F62;">test-boot.sh</span></span>
<span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">./test-boot.sh</span></span></code></pre></div><p>检查效果</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">tail</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/root/test-boot.log</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">tail</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/root/test-boot.log</span></span></code></pre></div><h2 id="配置开机启动" tabindex="-1">配置开机启动 <a class="header-anchor" href="#配置开机启动" aria-label="Permalink to &quot;配置开机启动&quot;">​</a></h2><p>如下配置是照抄<a href="https://docs.freebsd.org/en/books/handbook/config/#configtuning-starting-services" target="_blank" rel="noreferrer"><code>freebsd</code>官方文档<code>Starting Services</code></a></p><p>主要的不同是把原文中的配置文件从<code>utility</code>参数全部替换为<code>test_boot</code>，即<code>utility</code>服务替换为<code>test_boot</code>服务，该服务会在<code>DAEMON</code> <code>pseudo-service</code>之后启动</p><p>注意不要携带后缀<code>.sh</code></p><p><code>/etc/rc.d/test_boot</code></p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#!/bin/sh</span></span>
<span class="line"><span style="color:#6A737D;"># </span></span>
<span class="line"><span style="color:#6A737D;"># PROVIDE: test_boot</span></span>
<span class="line"><span style="color:#6A737D;"># REQUIRE: DAEMON</span></span>
<span class="line"><span style="color:#6A737D;"># KEYWORD: shutdown</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF;">.</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/rc.subr</span></span>
<span class="line"><span style="color:#E1E4E8;">name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">test_boot</span></span>
<span class="line"><span style="color:#E1E4E8;">rcvar</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">test_boot_enable</span></span>
<span class="line"><span style="color:#E1E4E8;">command</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;/root/test-boot.sh&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">load_rc_config</span><span style="color:#E1E4E8;"> $name</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#</span></span>
<span class="line"><span style="color:#6A737D;"># DO NOT CHANGE THESE DEFAULT VALUES HERE</span></span>
<span class="line"><span style="color:#6A737D;"># SET THEM IN THE /etc/rc.conf FILE</span></span>
<span class="line"><span style="color:#6A737D;">#</span></span>
<span class="line"><span style="color:#E1E4E8;">test_boot_enable</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">\${test_boot_enable-</span><span style="color:#9ECBFF;">&quot;NO&quot;</span><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#E1E4E8;">pidfile</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">\${test_boot_pidfile-</span><span style="color:#9ECBFF;">&quot;/var/run/test_boot.pid&quot;</span><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">run_rc_command</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#79B8FF;">$1</span><span style="color:#9ECBFF;">&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#!/bin/sh</span></span>
<span class="line"><span style="color:#6A737D;"># </span></span>
<span class="line"><span style="color:#6A737D;"># PROVIDE: test_boot</span></span>
<span class="line"><span style="color:#6A737D;"># REQUIRE: DAEMON</span></span>
<span class="line"><span style="color:#6A737D;"># KEYWORD: shutdown</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;">.</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/rc.subr</span></span>
<span class="line"><span style="color:#24292E;">name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">test_boot</span></span>
<span class="line"><span style="color:#24292E;">rcvar</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">test_boot_enable</span></span>
<span class="line"><span style="color:#24292E;">command</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;/root/test-boot.sh&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">load_rc_config</span><span style="color:#24292E;"> $name</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#</span></span>
<span class="line"><span style="color:#6A737D;"># DO NOT CHANGE THESE DEFAULT VALUES HERE</span></span>
<span class="line"><span style="color:#6A737D;"># SET THEM IN THE /etc/rc.conf FILE</span></span>
<span class="line"><span style="color:#6A737D;">#</span></span>
<span class="line"><span style="color:#24292E;">test_boot_enable</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">\${test_boot_enable-</span><span style="color:#032F62;">&quot;NO&quot;</span><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#24292E;">pidfile</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">\${test_boot_pidfile-</span><span style="color:#032F62;">&quot;/var/run/test_boot.pid&quot;</span><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">run_rc_command</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;</span><span style="color:#005CC5;">$1</span><span style="color:#032F62;">&quot;</span></span></code></pre></div><p>参数与命令解释</p><ul><li><p><code>. /etc/rc.subr</code>: 加载<code>rc.subr</code>定义的参数和函数</p></li><li><p><code>PROVIDE: test_boot</code>: 指定此文件所提供的服务的名字，该字段是必须的</p></li><li><p><code>REQUIRE: DAEMON</code>: 列出此服务启动之前所需要的其他服务，非必须字段，但是推荐自定义的服务填写为<code>DAEMON</code>，这样可以保证自定义服务在所有通用守护进程之后运行，以免太早运行产生不必要的依赖错误</p></li><li><p><code>name=test_boot</code>: 配置服务名称是test_boot</p></li><li><p><code>rcvar=test_boot_enable</code>: 配置服务是否开机自启动参数, 可以使用<code>/etc/rc.d/test_boot rcvar</code>命令来检查服务是否在<code>/etc/rc.conf</code>中被启用</p></li><li><p><code>command=&quot;/root/test-boot.sh&quot;</code>: 配置启动命令位置, 如果该服务是阻塞的，则需要修改<code>command=&quot;some-service &amp;&quot;</code></p></li></ul><p>更多配置项或者使用可以参考<code>/etc/rc.d/sshd</code>文件</p><p>增加执行权限</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">chmod</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">a+x</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/rc.d/test_boot</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">chmod</span><span style="color:#24292E;"> </span><span style="color:#032F62;">a+x</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/rc.d/test_boot</span></span></code></pre></div><p>编辑<code>/etc/rc.conf</code>，新增一行数据允许开机自启动</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">test_boot_enable</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;YES&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">test_boot_enable</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;YES&quot;</span></span></code></pre></div><p>最后重启查看<code>/root/test-boot.log</code>文件验证</p><h2 id="拓展阅读" tabindex="-1">拓展阅读 <a class="header-anchor" href="#拓展阅读" aria-label="Permalink to &quot;拓展阅读&quot;">​</a></h2><p>配置<code>freebsd</code>软件包源为国内中科大源</p><p>创建配置文件<code>/usr/local/etc/pkg/repos/FreeBSD.conf</code></p><div class="language-ini vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ini</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">FreeBSD: {</span></span>
<span class="line"><span style="color:#E1E4E8;">  url: </span><span style="color:#9ECBFF;">&quot;pkg+http://mirrors.ustc.edu.cn/freebsd-pkg/\${ABI}/quarterly&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">FreeBSD: {</span></span>
<span class="line"><span style="color:#24292E;">  url: </span><span style="color:#032F62;">&quot;pkg+http://mirrors.ustc.edu.cn/freebsd-pkg/\${ABI}/quarterly&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>更新索引</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pkg</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">update</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pkg</span><span style="color:#24292E;"> </span><span style="color:#032F62;">update</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span></span></code></pre></div><p>安装<code>vim</code></p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pkg</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">vim</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pkg</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">vim</span></span></code></pre></div><h2 id="参考阅读" tabindex="-1">参考阅读 <a class="header-anchor" href="#参考阅读" aria-label="Permalink to &quot;参考阅读&quot;">​</a></h2><p><a href="https://docs.freebsd.org/en/books/handbook/config/#configtuning-starting-services" target="_blank" rel="noreferrer"><code>freebsd</code>官方文档<code>Starting Services</code></a></p><p><a href="https://man.freebsd.org/cgi/man.cgi?query=rc&amp;sektion=8&amp;format=html" target="_blank" rel="noreferrer"><code>FreeBSD System Manager&#39;s Manual</code></a></p><p><a href="https://mirrors.ustc.edu.cn/help/freebsd-pkg.html" target="_blank" rel="noreferrer">中科大<code>FreeBSD pkg </code>源使用帮助</a></p>`,35),l=[p];function t(c,r,i,d,E,y){return a(),n("div",null,l)}const b=s(e,[["render",t]]);export{u as __pageData,b as default};
